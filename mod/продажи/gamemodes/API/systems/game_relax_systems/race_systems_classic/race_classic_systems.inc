new Float:gRace[MAX_RACE_COUNT][51][3] =
{
	{
		{-2623.7532,2190.6719,52.8484}, 	// Гоночная трасса 1 / трасса
		{-2618.1038,2300.2795,52.8493}, 	// Гоночная трасса 1 / трасса
		{-2468.0781,2482.2434,44.3476}, 	// Гоночная трасса 1 / трасса
		{-2298.8655,2529.1282,39.8981}, 	// Гоночная трасса 1 / трасса
		{-1968.0992,2493.8970,38.9232}, 	// Гоночная трасса 1 / трасса
		{-1643.3628,2500.6890,42.7783}, 	// Гоночная трасса 1 / трасса
		{-1421.1221,2323.1255,45.7075}, 	// Гоночная трасса 1 / трасса
		{-1299.6594,1867.3824,44.5321}, 	// Гоночная трасса 1 / трасса
		{-1188.6312,1618.1301,35.3396}, 	// Гоночная трасса 1 / трасса
		{-839.3198,1497.5151,23.4055}, 	// Гоночная трасса 1 / трасса
		{-707.2933,1337.0687,20.6053}, 	// Гоночная трасса 1 / трасса
		{-497.6988,1225.7019,20.0354}, 	// Гоночная трасса 1 / трасса
		{-378.9227,1102.6841,11.8546}, 	// Гоночная трасса 1 / трасса
		{-378.8564,881.3996,11.8568}, 	// Гоночная трасса 1 / трасса
		{-378.9227,624.3283,11.8563}, 	// Гоночная трасса 1 / трасса
		{-271.4376,598.0721,11.1816}, 	// Гоночная трасса 1 / трасса
		{-23.5306,566.5311,11.1782}, 		// Гоночная трасса 1 / трасса
		{157.2911,523.1476,11.1783}, 		// Гоночная трасса 1 / трасса
		{334.7454,453.3421,11.1785}, 		// Гоночная трасса 1 / трасса
		{528.5248,400.4889,11.0749}, 		// Гоночная трасса 1 / трасса
		{653.7897,522.3190,11.1797}, 		// Гоночная трасса 1 / трасса
		{736.4756,738.0362,11.1777}, 		// Гоночная трасса 1 / трасса
		{785.5108,925.3675,11.1752},		// Гоночная трасса 1 / трасса
		{698.8919,1068.2997,11.1755}, 		// Гоночная трасса 1 / трасса
		{382.7932,1149.6409,11.1803}, 		// Гоночная трасса 1 / трасса
		{300.2630,1280.1681,11.0735}, 	// Гоночная трасса 1 / трасса
		{326.7292,1566.0298,11.1761},	// Гоночная трасса 1 / трасса
		{258.6886,1688.0874,11.1758},		// Гоночная трасса 1 / трасса
		{158.8370,1483.3014,11.1757},	// Гоночная трасса 1 / трасса
		{32.1788,918.4692,11.1772},	// Гоночная трасса 1 / трасса
		{-121.5540,926.9085,11.1786}, 		// Гоночная трасса 1 / трасса
		{-328.7025,971.2757,11.1790}, 		// Гоночная трасса 1 / трасса
		{-378.6396,831.6685,11.1786}, 	// Гоночная трасса 1 / трасса
		{-378.9732,645.9656,11.1794}, 	// Гоночная трасса 1 / трасса
		{-336.3163,605.2652,11.1902}, 	// Гоночная трасса 1 / трасса
		{-329.0144,546.0753,11.8085}, 	// Гоночная трасса 1 / трасса
		{-371.3305,183.1169,12.6957}, 	// Гоночная трасса 1 / трасса
		{-390.5635,-11.7110,12.8777}, 	// Гоночная трасса 1 / трасса
		{-280.5308,-158.6929,12.2514}, 	// Гоночная трасса 1 / трасса
		{-73.2206,-146.9436,12.0849}, 	// Гоночная трасса 1 / трасса
		{161.2263,-137.5460,12.2505}, 	// Гоночная трасса 1 / трасса
		{327.8012,-82.4689,12.0538}, 		// Гоночная трасса 1 / трасса
		{381.8289,24.2946,11.1773}, 		// Гоночная трасса 1 / трасса
		{191.4686,31.4684,11.6882}, 		// Гоночная трасса 1 / трасса
		{-85.8217,22.8035,11.7347}, 		// Гоночная трасса 1 / трасса
		{-233.2702,64.1904,11.7761}, 		// Гоночная трасса 1 / трасса
		{-213.5260,142.8649,11.8351}, 	// Гоночная трасса 1 / трасса
		{-78.8447,162.4880,11.8170}, 		// Гоночная трасса 1 / трасса
		{70.1701,163.6266,11.7819},		// Гоночная трасса 1 / трасса
		{211.9717,165.3726,11.7887},		// Гоночная трасса 1 / трасса ФИНИШ
		{0.0, 0.0, 0.0}
	},
	{
		{1717.8784,2959.9746,11.1734}, 	// Трасса 2 / трасса
		{2113.9136,2959.8164,10.9565}, 	// Трасса 2 / трасса
		{2422.0984,2948.8894,21.8289}, 	// Трасса 2 / трасса
		{2699.1855,2643.3108,15.8206}, 	// Трасса 2 / трасса
		{2755.4033,2293.9146,15.7974}, 	// Трасса 2 / трасса
		{2744.9124,1866.3120,15.3839}, 	// Трасса 2 / трасса
		{2686.5928,1625.8356,16.4541}, 	// Трасса 2 / трасса
		{2564.4849,1506.0118,11.8159}, 	// Трасса 2 / трасса
		{2589.5378,1299.9083,18.1771}, 	// Трасса 2 / трасса
		{2717.5410,1044.3048,18.4252}, 	// Трасса 2 / трасса
		{2849.7349,754.1265,30.9724},	// Трасса 2 / трасса
		{2906.1006,476.8323,25.3955},	// Трасса 2 / трасса
		{2906.6458,-65.7070,24.4826},	// Трасса 2 / трасса
		{2836.4702,-345.1195,26.1093},	// Трасса 2 / трасса
		{2742.0925,-584.7511,23.0716},	// Трасса 2 / трасса
		{2742.1655,-793.3181,23.0532},	// Трасса 2 / трасса
		{2742.1560,-1058.8773,22.7231},	// Трасса 2 / трасса
		{2741.7935,-1402.4847,22.9930},	// Трасса 2 / трасса
		{2571.1563,-1516.0336,22.9596},	// Трасса 2 / трасса
		{2411.4204,-1520.8452,23.0379},	// Трасса 2 / трасса
		{2285.7161,-1660.3522,21.4097},	// Трасса 2 / трасса
		{2285.1406,-1821.9188,20.9921},	// Трасса 2 / трасса
		{2285.1211,-1981.6045,21.0068},	// Трасса 2 / трасса
		{2235.6052,-2135.2834,20.9912},	// Трасса 2 / трасса
		{2227.3787,-2234.6062,20.9443},	// Трасса 2 / трасса
		{2113.1387,-2255.3250,17.0986},	// Трасса 2 / трасса
		{1908.5334,-2255.2703,10.0060},	// Трасса 2 / трасса
		{1804.8481,-2269.5620,10.0067},	// Трасса 2 / трасса
		{1858.7009,-2402.2388,10.0141},	// Трасса 2 / трасса
		{1938.9563,-2600.2148,9.9946},	// Трасса 2 / трасса
		{1941.1462,-2667.5730,10.4164},	// Трасса 2 / трасса
		{1960.5350,-2685.2493,10.3697},	// Трасса 2 / трасса
		{2116.6201,-2685.2058,11.3325},	// Трасса 2 / трасса
		{2319.4749,-2685.5615,24.4884},	// Трасса 2 / трасса
		{2574.7490,-2685.4133,24.4954},	// Трасса 2 / трасса
		{2702.8115,-2682.4224,23.9302},	// Трасса 2 / трасса
		{2761.5972,-2549.6753,20.8422},	// Трасса 2 / трасса
		{2794.0056,-2400.8411,20.8624},	// Трасса 2 / трасса
		{2793.7905,-2208.4609,17.9879},	// Трасса 2 / трасса
		{2737.4250,-2155.3794,20.5748},	// Трасса 2 / трасса
		{2714.9783,-2084.0325,22.5272},	// Трасса 2 / трасса
		{2707.0806,-1918.9320,34.8835},	// Трасса 2 / трасса
		{2571.3342,-1764.7831,34.8710},	// Трасса 2 / трасса
		{2359.0217,-1753.6495,22.8841},	// Трасса 2 / трасса
		{2228.7048,-1753.7346,20.9946},	// Трасса 2 / трасса
		{2113.8105,-1757.4156,18.0712}, 	// Трасса 2 / трасса
		{2104.9355,-1822.5591,17.9882}, 	// Трасса 2 / трасса
		{2105.0139,-1881.3739,17.9937}, 	// Трасса 2 / трасса ФИНИШ
		{0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0}
	}
};

new Float:gRaceSpawn[MAX_RACE_COUNT][22][4] =
{
	{
		{-2634.5693,2041.5579,52.8657,359.6693}, 	// Гоночная трасса 1 / Позиция старта 1
 		{-2626.7432,2040.8964,52.8651,0.0012}, 		// Гоночная трасса 1 / Позиция старта 2
 		{-2627.4729,2029.0504,52.9115,359.9998}, 	// Гоночная трасса 1 / Позиция старта 3
 		{-2635.2051,2029.9094,52.9064,359.9999}, 	// Гоночная трасса 1 / Позиция старта 4
 		{-2635.7678,2018.0859,52.9117,359.9998}, 	// Гоночная трасса 1 / Позиция старта 5
 		{-2628.1785,2017.3048,52.9071,359.9998}, 	// Гоночная трасса 1 / Позиция старта 6
 		{-2628.4585,2005.5161,52.9098,359.9998}, 	// Гоночная трасса 1 / Позиция старта 7
 		{-2636.4170,2006.2163,52.9162,0.0010}, 		// Гоночная трасса 1 / Позиция старта 8
 		{-2636.9756,1994.5383,52.9148,359.9998}, 	// Гоночная трасса 1 / Позиция старта 9
 		{-2629.1145,1993.6615,52.9101,359.8385}, 	// Гоночная трасса 1 / Позиция старта 10
 		{-2629.8582,1981.3075,52.9141,0.0025}, 		// Гоночная трасса 1 / Позиция старта 11
 		{-2637.5603,1982.4198,52.9066,359.9999}, 	// Гоночная трасса 1 / Позиция старта 12
 		{-2638.1382,1970.9459,52.9120,0.3088}, 		// Гоночная трасса 1 / Позиция старта 13
 		{-2630.7654,1969.7188,52.9091,359.9998}, 	// Гоночная трасса 1 / Позиция старта 14
 		{-2631.2834,1958.1583,52.9127,359.9998}, 	// Гоночная трасса 1 / Позиция старта 15
 		{-2638.8391,1959.0796,52.9076,359.9999}, 	// Гоночная трасса 1 / Позиция старта 16
 		{-2639.4209,1947.2513,52.9085,359.9998}, 	// Гоночная трасса 1 / Позиция старта 17
 		{-2631.5754,1946.7506,52.9080,359.9998},		// Гоночная трасса 1 / Позиция старта 18
 		{0.0, 0.0, 0.0},
 		{0.0, 0.0, 0.0},
 		{0.0, 0.0, 0.0},
 		{0.0, 0.0, 0.0}
 	},
 	{
 		{1594.0360,2963.7175,11.8566,270.8910}, 	// Трасса 2 / Позиция спавна авто 1
		{1594.1348,2955.9319,11.8541,270.7623}, 	// Трасса 2 / Позиция спавна авто 2
		{1583.3782,2963.7876,11.8516,269.4936}, 	// Трасса 2 / Позиция спавна авто 3
		{1583.2786,2955.8140,11.8539,269.4647}, 	// Трасса 2 / Позиция спавна авто 4
		{1572.3882,2956.0134,11.8535,270.1189}, 	// Трасса 2 / Позиция спавна авто 5
		{1572.6592,2963.8555,11.8544,269.2768}, 	// Трасса 2 / Позиция спавна авто 6
		{1561.8407,2963.9443,11.8540,270.3615}, 	// Трасса 2 / Позиция спавна авто 7
		{1561.8761,2955.8616,11.8534,270.4174}, 	// Трасса 2 / Позиция спавна авто 8
		{1551.2020,2964.0754,11.8540,269.4599}, 	// Трасса 2 / Позиция спавна авто 9
		{1551.0061,2955.8972,11.8535,270.3643}, 	// Трасса 2 / Позиция спавна авто 10
		{1540.5273,2956.0054,11.8538,270.5391}, 	// Трасса 2 / Позиция спавна авто 11
		{1539.9604,2963.9343,11.8539,269.2118}, 	// Трасса 2 / Позиция спавна авто 12
		{1529.1104,2963.9902,11.8541,270.3815}, 	// Трасса 2 / Позиция спавна авто 13
		{1529.1508,2956.0242,11.8541,269.5105}, 	// Трасса 2 / Позиция спавна авто 14
		{1518.5699,2955.9556,11.8533,268.1008}, 	// Трасса 2 / Позиция спавна авто 15
		{1518.4622,2963.9390,11.8531,270.5346}, 	// Трасса 2 / Позиция спавна авто 16
		{1507.4403,2963.8420,11.8533,270.6241}, 	// Трасса 2 / Позиция спавна авто 17
		{1507.4305,2955.9951,11.8528,268.5503}, 	// Трасса 2 / Позиция спавна авто 18
		{1496.5558,2955.9993,11.8533,268.9841}, 	// Трасса 2 / Позиция спавна авто 19
		{1496.4994,2963.7930,11.8537,270.3123}, 	// Трасса 2 / Позиция спавна авто 20
		{1485.6631,2963.8750,11.8550,271.3255}, 	// Трасса 2 / Позиция спавна авто 21
		{1486.0098,2955.9565,11.8540,270.9520} 		// Трасса 2 / Позиция спавна авто 22
 	} 	
};


stock create_race_area()
{

	arRegisterArea = CreateDynamicSphere(-1509.5198,1608.2966,36.7735, 75.0, 0, 0);
	arRegistrInRace = create_circle_pickup(-1509.5198,1608.2966,36.7735, TRIGGER_LRED);

	CreateDynamic3DTextLabel(""cWH"Регистрация на гонку\n\
		"cLRED"[Встаньте на пикап]", CWHITE, -1509.5198,1608.2966,36.7735, 5.0,INVALID_PLAYER_ID, INVALID_VEHICLE_ID, 0, -1);

	return true;
}


CMD:racestart(playerid, params[])
{
	if(pData[playerid][pAdmin] < 7)
		return NoCMD(playerid);

	if(sscanf(params, "d", params[0])) 
		return SendInf(playerid, ""cWH"Используйте: /racestart [минуты] - используйте -1 для отмены гонки");

	if(params[0] == -1)
	{
		race_time_start = 0;
		remove_sound_race_checkpoint();
		return true;
	}

	reset_winner_race_info();

	//remove_sound_race_checkpoint();
	//create_sound_race_checkpoint();

	race_time_start = params[0] ? params[0] * 60 : 2;

	static str[128];
	format(str,sizeof(str), "[Мероприятие] Мероприятие 'Гонки' начнётся через %s!", time_to_words(race_time_start));
	SendClientMessageToAll(COLOR_YELLOW, str);
	SendClientMessageToAll(COLOR_YELLOW, "[Мероприятие] Регистрация проводится возле гоночного трека! (( /gps - Развлечения - Гонки ))");

	race_info[race_status] = 1;

	new
		type_random = random(2);

	race_info[race_type] = type_random+1;


	switch(race_info[race_type])
	{
		case 1: 
		{
			switch(random(5))
			{
				case 0: race_info[race_cars_select] = 603;
				case 1: race_info[race_cars_select] = 401;
				case 2: race_info[race_cars_select] = 405;
				case 3: race_info[race_cars_select] = 410;
				case 4: race_info[race_cars_select] = 415;
			}

			race_info[race_maxcount] = 18;
		}
		case 2: 
		{
			switch(random(5))
			{
				case 0: race_info[race_cars_select] = 603;
				case 1: race_info[race_cars_select] = 401;
				case 2: race_info[race_cars_select] = 405;
				case 3: race_info[race_cars_select] = 410;
				case 4: race_info[race_cars_select] = 415;
			}

			race_info[race_maxcount] = 22; 
		}
	}

	return true;
}

stock start_race_new()
{
	reset_winner_race_info();

	remove_sound_race_checkpoint();
	create_sound_race_checkpoint();

	new 
		race_timse = 15;

	race_time_start = race_timse ? race_timse * 60 : 2;

	static str[128];
	format(str,sizeof(str), "[Мероприятие] Мероприятие 'Гонки' начнётся через %s!", time_to_words(race_time_start));
	SendClientMessageToAll(COLOR_YELLOW, str);
	SendClientMessageToAll(COLOR_YELLOW, "[Мероприятие] Регистрация проводится возле гоночного трека! (( /gps - Развлечения - Гонки ))");

	race_info[race_status] = 1;

	new
		type_random = random(2);

	race_info[race_type] = type_random+1;


	switch(race_info[race_type])
	{
		case 1: 
		{
			switch(random(5))
			{
				case 0: race_info[race_cars_select] = 603;
				case 1: race_info[race_cars_select] = 401;
				case 2: race_info[race_cars_select] = 405;
				case 3: race_info[race_cars_select] = 410;
				case 4: race_info[race_cars_select] = 415;
			}

			race_info[race_maxcount] = 18;
		}
		case 2: 
		{
			switch(random(5))
			{
				case 0: race_info[race_cars_select] = 603;
				case 1: race_info[race_cars_select] = 401;
				case 2: race_info[race_cars_select] = 405;
				case 3: race_info[race_cars_select] = 410;
				case 4: race_info[race_cars_select] = 415;
			}
			
			race_info[race_maxcount] = 22; 
		}
	}
	return true;
}


callback:: race_start_mode()
{
	if(!race_time_start) 
		return true;

	foreach(new i : logged_players)
	{
		if(!IsPlayerConnected(i))
			continue;
		if(GetPVarIntNew(i, "race_window_open") == 1)
		{
			gui_interface_race_start(i, TEXTDRAW_UPDATE);
		}
	}

	race_time_start--;

	if(!race_time_start) 
		return start_race(); 

	if(race_time_start == 30 || race_time_start == 90 || race_time_start == 120 || race_time_start == 150 || race_time_start == 200 || race_time_start == 250 || race_time_start == 350 || race_time_start == 500)
	{
		static str[128];
		format(str,sizeof(str), "[Мероприятие] Мероприятие 'Гонки' начнётся через %s!", time_to_words(race_time_start));
		SendClientMessageToAll(COLOR_YELLOW, str);

		return SendClientMessageToAll(COLOR_YELLOW, "[Мероприятие] Регистрация проводится возле гоночного трека! (( /gps - Развлечения - Гонки ))");
	}

	else if(race_time_start == 45)
	{
		foreach(new i : Player_In_Race)
		{
			if(!IsPlayerConnected(i))
				continue;

			create_sound_race(i);

			gui_interface_race_start(i, TEXTDRAW_HIDE);

			TextDrawShowForPlayer(i, race_car_in_box[0]);
			TextDrawShowForPlayer(i, race_car_in_box[1]);


			gui_interface_timer_start(i, race_time_start);

			TogglePlayerAllHudElements(i, HUD_ELEMENT_HIDE);

			SetPlayerVirtualWorld(i, i+1);

			SetPlayerPos(i, -1613.6147,1580.4965,35.6989);
			SetPlayerFacingAngle(i, 277.1169);

			hide_hud_element(i);

			TogglePlayerControllable(i, 0);

			new 
				c1 = random(255);

			race_info[race_car][i] = CreateVehicle(race_info[race_cars_select], -1615.9423,1579.1119,35.4019,269.8249, c1, c1, -1);
			SetVehicleVirtualWorld(race_info[race_car][i], GetPlayerVirtualWorld(i));

			InterpolateCameraPos(i, -1607.269287, 1573.074951, 37.356525, -1611.838500, 1581.222167, 36.017200, 5000);
			InterpolateCameraLookAt(i, -1611.247680, 1576.056396, 36.823600, -1616.262573, 1578.907836, 35.750743, 5000);	
		}

	}
	else if(race_time_start < 45)
	{
		foreach(new i : Player_In_Race)
		{
			gui_interface_timer_start(i, race_time_start);
		}
	}

	return true;
}

callback:: race_start_player()
{

	race_timer_start();
	remove_sound_race_checkpoint();

    return true;
}

stock create_sound_race_checkpoint()
{
	/*new 
		sound_random = random(22);

	format(String64, sizeof(String64), "http://dl.b-rp.ru/sound_game/race_sound_%d.mp3", sound_random+1);
	sound_zone_stream[7] = CreateStreamSource(-1509.5198,1608.2966,36.7735, 50.0, -1, -1, String64);*/
	return true;
} 

stock remove_sound_race_checkpoint()
{
	//DestroyStreamSource(sound_zone_stream[7]);
	return true;
}


stock create_sound_race(playerid)
{
	/*PlayerPlayStream(playerid, "");

	new 
		sound_random = random(22);
	format(String64, sizeof(String64), "http://dl.b-rp.ru/sound_game/race_sound_%d.mp3", sound_random+1);
	PlayerPlayStream(playerid, String64);*/

	return true;
}

stock remove_sound_race(playerid)
{
	PlayerPlayStream(playerid, "");

	return true;
}

stock gui_interface_pos_race(playerid, status)
{

	switch(status)
	{
		case TEXTDRAW_SHOW:
		{

		}
		case TEXTDRAW_UPDATE:
		{

		}
		case TEXTDRAW_HIDE:
		{

		}
	}
	return true;
}

stock gui_interface_race_start(playerid, status)
{

	switch(status)
	{
		case TEXTDRAW_SHOW:
		{
			TextDrawShowForPlayer(playerid, race_interface_g[0]);
			TextDrawShowForPlayer(playerid, race_interface_g[1]);
			TextDrawShowForPlayer(playerid, race_interface_g[2]);
			TextDrawShowForPlayer(playerid, race_interface_g[5]);

			create_player_button_race(playerid);

			if(GetPVarIntNew(playerid, "RegInRace"))
			{
				PlayerTextDrawSetString(playerid, race_player_button[playerid], "brilliantother:race_button_2");
				PlayerTextDrawShow(playerid, race_player_button[playerid]);	
			}
			else
			{
				PlayerTextDrawSetString(playerid, race_player_button[playerid], "brilliantother:race_button_1");
				PlayerTextDrawShow(playerid, race_player_button[playerid]);					
			}

			format(String144, sizeof(String144), "%s", time_to_string(race_time_start));
			TextDrawSetString(race_interface_g[3], String144);
			TextDrawShowForPlayer(playerid, race_interface_g[3]);

			format(String144, sizeof(String144), "%d_RUB", 1000);
			TextDrawSetString(race_interface_g[4], String144);
			TextDrawShowForPlayer(playerid, race_interface_g[4]);

			SelectTextDraw(playerid, COLOR_BLUE);

			SetPVarIntNew(playerid, "race_window_open", 1);

			TogglePlayerAllHudElements(playerid, HUD_ELEMENT_HIDE);


		}
		case TEXTDRAW_HIDE:
		{
			TextDrawHideForPlayer(playerid, race_interface_g[0]);
			TextDrawHideForPlayer(playerid, race_interface_g[1]);
			TextDrawHideForPlayer(playerid, race_interface_g[2]);
			TextDrawHideForPlayer(playerid, race_interface_g[3]);
			TextDrawHideForPlayer(playerid, race_interface_g[4]);	
			TextDrawHideForPlayer(playerid, race_interface_g[5]);
			
			PlayerTextDrawHideEx(playerid, race_player_button[playerid]);	

			CancelSelectTextDraw(playerid);	

			DeletePVarNew(playerid, "race_window_open");

			TogglePlayerAllHudElements(playerid, HUD_ELEMENT_SHOW);
		}
		case TEXTDRAW_UPDATE:
		{
			if(GetPVarIntNew(playerid, "RegInRace"))
			{
				PlayerTextDrawSetString(playerid, race_player_button[playerid], "brilliantother:race_button_2");
				PlayerTextDrawShow(playerid, race_player_button[playerid]);	
			}
			else
			{
				PlayerTextDrawSetString(playerid, race_player_button[playerid], "brilliantother:race_button_1");
				PlayerTextDrawShow(playerid, race_player_button[playerid]);					
			}

			format(String144, sizeof(String144), "%s", time_to_string(race_time_start));
			TextDrawSetString(race_interface_g[3], String144);
			TextDrawShowForPlayer(playerid, race_interface_g[3]);

			format(String144, sizeof(String144), "%d_RUB", 1000);
			TextDrawSetString(race_interface_g[4], String144);
			TextDrawShowForPlayer(playerid, race_interface_g[4]);

			SelectTextDraw(playerid, COLOR_BLUE);
		}
	}


	return true;
}


stock gui_interface_timer_start(playerid, time)
{

	TextDrawShowForPlayer(playerid, race_timer_global[0]);

	format(String64, sizeof(String64), "%s", time_to_string(time));
	TextDrawSetString(race_timer_global[1], String64);
	TextDrawShowForPlayer(playerid, race_timer_global[1]);


	return true;
}


stock disconnect_player_in_race(playerid)
{

	if(race_info[race_status] == 1 && GetPVarIntNew(playerid, "RegInRace"))
	{
		race_info[race_count] --;
	}
	else if(race_info[race_status] >= 2 && GetPVarIntNew(playerid, "RegInRace"))
	{
		race_info[race_count] --;
		if(race_info[race_car][playerid] != INVALID_VEHICLE_ID)
		{
			DestroyVehicle(race_info[race_car][playerid]);
			race_info[race_car][playerid] = INVALID_VEHICLE_ID;
		}
		RaceTimer[playerid] = 0;
	}
	return true;
}

stock invite_to_race_player(playerid)
{

	if(!pData[playerid][pLicenses][LIC_DRIVING]) 
		return SendErr(playerid, "У Вас нет лицензии на авто");

	if(race_info[race_status] != 1)
	{
		show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_5", 3500);	
		return SendErr(playerid, "Регистрация на гонку сейчас закрыта");
	}

	if(race_info[race_count] == race_info[race_maxcount])
	{
		show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_4", 3500);	
		return SendErr(playerid, "Все места на гонку заняты");
	}

	if(GetPlayerMoneyEx(playerid) < 1000)
		return SendErr(playerid, "У Вас недостаточно денег для регистрации");

	if(GetPVarIntNew(playerid, "RegInRace") == 1)
		return SendErr(playerid, "Вы уже зарегистрированы на гонку!");

	give_money(playerid, -1000, "Регистрация на гонку");

	SetPVarIntNew(playerid, "RegInRace", 1);
	race_info[race_count] ++;

	SetPVarIntNew(playerid, "race_player_number", race_info[race_count]+1);

	show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_1", 3500);	

	SendSucc(playerid, "Вы зарегистрировались на гонку");
	SendInf(playerid, "Не покидайте место регистрации, поскольку будете исключены из гонки.");

	Iter_Add(Player_In_Race, playerid);

	return 1;

}


stock start_race()
{
	if(race_info[race_status] != 1)
		return printf("[A] Гонка не запущена (Ошибка #2412)");



	reset_winner_race_info();

	if(race_info[race_count] < 4)
	{
		SendClientMessageToAll(COLOR_YELLOW, "[Мероприятие] На мероприятие 'Гонки' не было собрано нужное количество участников!");
		race_info[race_status] = 0;
		race_info[race_count] = 0;
		race_info[race_maxcount] = 0;
		race_info[race_timer] = 0;
		race_info[race_lastplace] = 0;
		race_info[end_timer] = 0;

		remove_sound_race_checkpoint();

		foreach(new i : Player_In_Race)
		{
			//give_money(i, 1000, "Возврат за регистрацию на гонке!");
			reset_player_race(i);
			spawn_before_race(i);
			TextDrawHideForPlayer(i, race_car_in_box[0]);
			TextDrawHideForPlayer(i, race_car_in_box[1]);			
		}
		return true;

	}

	race_info[race_status] = 2;
	race_info[race_prizepool] = race_info[race_count]*1000;

	new
		count;
	foreach(new i : Player_In_Race)
	{
		if(!IsPlayerConnected(i))
			continue;

		SetPlayerVirtualWorld(i, 1);

		create_sound_race(i);
		count++;
		DestroyVehicle(race_info[race_car][i]);

		spawn_car_in_race(i, race_info[race_type], count);
		spawn_cp_in_race(i, race_info[race_type]);

		SetCameraBehindPlayer(i);

		vehicle[race_info[race_car][i]][cFuel] = 80;
		SetVehicleVirtualWorld(race_info[race_car][i], 1);
		PutPlayerInVehicle(i, race_info[race_car][i], 0);
		TogglePlayerControllable(i, 0);

		race_info[race_timer] = 15;

		TextDrawHideForPlayer(i, race_car_in_box[0]);
		TextDrawHideForPlayer(i, race_car_in_box[1]);

		show_hud_element(i);
		show_hud_hungry(i);

		//race_timer_start();

		TogglePlayerAllHudElements(i, HUD_ELEMENT_SHOW);

		gui_interface_timer_start(i, race_info[race_timer]);
	}
	SendRaceMessage(COLOR_YELLOW, "[Мероприятие] До старта гонок 15 секунд. /leave_race - покинуть гонку");
	return 1;
}


stock reset_winner_race_info()
{
	for(new i; i < 22; i++)
	{
		winner_info[i][winner_name] = 0;
		winner_info[i][winner_timer] = 0;
	}
}

stock spawn_car_in_race(playerid, type, count)
{
	race_info[race_car][playerid] = CreateVehicle(race_info[race_cars_select], gRaceSpawn[type-1][count-1][0], gRaceSpawn[type-1][count-1][1], gRaceSpawn[type-1][count-1][2], gRaceSpawn[type-1][count-1][3], -1, -1, -1);

}

stock spawn_cp_in_race(playerid, type)
{
	SetPVarIntNew(playerid, "RaceCP", 1);

	SetPlayerRaceCheckpoint(playerid, 0, gRace[type-1][0][0], gRace[type-1][0][1], gRace[type-1][0][2], gRace[type-1][1][0], gRace[type-1][1][1], gRace[type-1][1][2], 4.0);

}

stock race_checkpoint_enter(playerid)
{
	if(!GetPVarIntNew(playerid, "RaceCP") && !GetPVarIntNew(playerid, "RegInRace"))
		return 1;

	DisablePlayerRaceCheckpoint(playerid);
	SetPVarIntNew(playerid, "RaceCP", GetPVarIntNew(playerid, "RaceCP")+1);

	give_next_cp_race(playerid, GetPVarIntNew(playerid, "RaceCP"));
	return 1;
}

stock give_next_cp_race(playerid, id)
{
	if(!GetPVarIntNew(playerid, "RaceCP") && !GetPVarIntNew(playerid, "RegInRace"))
		return 1;

	new 
		type = race_info[race_type];

	if(gRace[type-1][id-1][0] == 0.0)
	{
		end_race_for_players(playerid);
	}
	else if(gRace[type-1][id][0] == 0.0)
	{
		SetPlayerRaceCheckpoint(playerid, 1, gRace[type-1][id-1][0], gRace[type-1][id-1][1], gRace[type-1][id-1][2], -1, -1, -1, 4.0);
	}
	else
	{
		SetPlayerRaceCheckpoint(playerid, 0, gRace[type-1][id-1][0], gRace[type-1][id-1][1], gRace[type-1][id-1][2], gRace[type-1][id][0], gRace[type-1][id][1], gRace[type-1][id][2], 4.0);
	}
	return 1;
}

stock end_race_for_players(playerid)
{
	if(race_info[race_lastplace] < 3)
	{
		race_info[race_lastplace]++;
		new 
			prizemoney = floatround(race_info[race_prizepool]/3);

		give_money(playerid, prizemoney, "Выигрыш на гонке");

		SendSucc(playerid, "Вы закончили гонку на призовом месте!");

		winner_info[race_info[race_lastplace]-1][winner_name] = pData[playerid][pMysqlID];

		winner_info[race_info[race_lastplace]-1][winner_timer] = RaceTimer[playerid];


		spawn_before_race(playerid);
		if(race_info[race_lastplace] == 3)
		{
			race_info[end_timer] = 60;
			SendRaceMessage(CBLUE, "[Мероприятие] До окончания осталась 1 минута");
		}
	}
	else
	{
		race_info[race_lastplace]++;
		SendSucc(playerid, "Вы закончили гонку");
		spawn_before_race(playerid);

		if(race_info[race_lastplace] == race_info[race_count])
			race_info[end_timer] = 10;
	}
	reset_player_race(playerid);
	return 1;
}

stock reset_player_race(playerid)
{
	if(playerid == INVALID_PLAYER_ID || playerid > MAX_PLAYERS)
		return true;

	DeletePVarNew(playerid, "RegInRace");
	DeletePVarNew(playerid, "RaceCP");
	if(race_info[race_car][playerid] != INVALID_VEHICLE_ID)
	{
		DestroyVehicle(race_info[race_car][playerid]);
		race_info[race_car][playerid] = INVALID_VEHICLE_ID;
	}
	RaceTimer[playerid] = 0;
	if(Iter_Contains(Player_In_Race, playerid))
		Iter_Remove(Player_In_Race, playerid);
	return 1;
}

stock SendRaceMessage(color, string[])
{
	foreach(new i : Player_In_Race)
	{
		SendClientMessage(i, color, string);
	}
	return 1;
}

stock spawn_before_race(playerid)
{
	new
		pos = random(4);

	switch(pos)
	{
		case 0: SetPlayerPos(playerid, -1504.2073,1618.7605,36.5690);
		case 1:	SetPlayerPos(playerid, -1501.3617,1602.4130,36.5690);
		case 2:	SetPlayerPos(playerid, -1504.4698,1632.3643,36.5690);
		case 3:	SetPlayerPos(playerid, -1503.9606,1597.3104,36.5690);
	}
	SetPlayerVirtualWorld(playerid, 0);

	return 1;
}

callback:: end_race_timer()
{
	if(race_info[race_status] != 3)
		return 1;

	race_info[end_timer] --;

	if(race_info[end_timer] == 1)
	{
		race_info[end_timer] --;
		foreach(new i : Player_In_Race)
		{
			reset_player_race(i);
			spawn_before_race(i);
			show_notify_gui(i, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_3", 3500);
			if(Iter_Contains(Player_In_Race, i))
				Iter_Remove(Player_In_Race, i);
		}
		race_info[race_status] = 0;
		race_info[race_count] = 0;
		race_info[race_maxcount] = 0;
		race_info[race_timer] = 0;
		race_info[race_lastplace] = 0;
		race_info[end_timer] = 0;
		SendClientMessageToAll(COLOR_YELLOW, !"[Мероприятие] Мероприятие 'Гонки' завершилось!");



	}
	return 1;
}

callback:: race_player_timer()
{
	if(race_info[race_status] == 3)
	{
		foreach(new i : Player_In_Race)
		{
			RaceTimer[i]++;
		}
	}
}
callback:: race_timer_start()
{
	if(race_info[race_status] != 2)
		return 1;

	race_info[race_timer] --;

	if(race_info[race_timer])
	{
		foreach(new i : Player_In_Race)
		{	
			vehicle_engine_status(GetPlayerVehicleID(i), false);
			gui_interface_timer_start(i, race_info[race_timer]);
		}
	}
	else if(!race_info[race_timer])
	{
		foreach(new i : Player_In_Race)
		{
			TextDrawHideForPlayer(i, race_timer_global[0]);
			TextDrawHideForPlayer(i, race_timer_global[1]);

			TogglePlayerControllable(i, 1);

			vehicle_engine_status(GetPlayerVehicleID(i), true);

			GameTextForPlayer(i, "~g~GO! GO! GO!", 5000, 3);
		}
		race_info[race_status] = 3;
		return SendClientMessageToAll(COLOR_YELLOW, !"[Мероприятие] Мероприятие 'Гонки' началось!");
	}
	return 1;
}

CMD:leave_race(playerid)
{
	leave_race_player(playerid);
	return true;
}

stock death_race_player(playerid)
{

	if(!GetPVarIntNew(playerid, "RegInRace") && !GetPVarIntNew(playerid, "RaceCP"))
		return 1;

	remove_sound_race(playerid);
	race_info[race_count] --;
	
	reset_player_race(playerid);
	spawn_before_race(playerid);

	DeletePVarNew(playerid, "race_player_number");

	show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_2", 3500);	

	SendSucc(playerid, "Вы покинули гонку");
	return true;
}

stock leave_race_player(playerid)
{

	if(!GetPVarIntNew(playerid, "RegInRace") && !GetPVarIntNew(playerid, "RaceCP"))
		return 1;

	remove_sound_race(playerid);
	race_info[race_count] --;
	
	reset_player_race(playerid);
	spawn_before_race(playerid);

	DeletePVarNew(playerid, "race_player_number");

	show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_128_CENTER, "brilliantother:info_gui_race_2", 3500);	

	SendSucc(playerid, "Вы покинули гонку");

	return true;
}


