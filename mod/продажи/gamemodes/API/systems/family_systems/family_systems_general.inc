static const Float:position_spawn_autosalon_1[][] =
{
	{496.2794,2258.6084,11.7864,331.0653},
	{491.8055,2260.8484,11.7943,333.1315},
	{487.6313,2263.0676,11.7870,332.1187},
	{483.2168,2265.4224,11.7925,331.1891},
	{478.8703,2267.6929,11.7871,331.8698},
	{474.2588,2270.1711,11.7943,331.1767},
	{470.0360,2272.3164,11.7868,332.5841},
	{466.3938,2265.9226,11.7933,152.0414},
	{470.5729,2263.6736,11.7977,151.6321},
	{475.2416,2261.0933,11.7947,150.7318},
	{479.5886,2258.7644,11.7906,151.7838},
	{483.8151,2256.5693,11.7933,150.8328},
	{488.2624,2254.2073,11.8024,151.2056},
	{492.5320,2251.9468,11.7952,151.3631},
	{469.4779,2221.2761,11.7944,241.3948},
	{467.0840,2216.8945,11.7644,242.7202},
	{464.6563,2212.6619,11.7958,242.1745},
	{462.2459,2208.3589,11.7964,242.2830},
	{459.7108,2204.0781,11.7975,242.5645},
	{455.0215,2195.5059,11.7864,242.2542},
	{452.4126,2191.2402,11.7864,240.9978},
	{449.7714,2186.6980,11.7864,239.2763},
	{447.8629,2182.9465,11.7864,238.4752},
	{445.7681,2179.1194,11.7864,240.7978},
	{443.6452,2175.2559,11.7864,240.4670},
	{441.6716,2171.5596,11.7864,239.1345},
	{514.0989,2220.1553,11.7864,60.7677},
	{511.7332,2215.4675,11.7864,62.6130},
	{509.2346,2210.8789,11.7864,66.0163},
	{507.2883,2206.9934,11.7864,62.1058},
	{505.1971,2202.9958,11.7865,63.4612},
	{503.3098,2199.5581,11.7864,61.1279},
	{501.3806,2195.9980,11.7864,63.0541},
	{499.4225,2192.2856,11.7864,62.3072},
	{497.4278,2188.7566,11.7894,62.3845},
	{495.5235,2185.5264,11.7901,63.3694},
	{493.8061,2181.7629,11.7901,64.5969},
	{492.0435,2178.5032,11.7901,62.3581},
	{490.1856,2174.8914,11.7907,65.0223},
	{488.2598,2171.1973,11.7939,63.4360},
	{486.5660,2167.7698,11.7939,64.0308}
};


static const Float:position_spawn_autosalon_2[][] =
{

	{380.6900,1177.7367,11.7935,172.7438}, 
	{385.4481,1177.2823,11.7949,174.8792}, 
	{390.2355,1176.5898,11.7565,173.8725}, 
	{394.9669,1176.0437,11.7951,175.1601}, 
	{400.3021,1175.5378,11.7993,173.2160}, 
	{405.2024,1174.9717,11.8041,175.5949}, 
	{410.1048,1174.3781,11.7652,173.0680}, 
	{467.7547,1188.5150,11.8001,107.4910}, 
	{468.4418,1193.6125,11.7984,106.8416}, 
	{468.9195,1198.2668,11.7910,110.1615}, 
	{469.4240,1203.0293,11.7936,106.9170}, 
	{469.9277,1207.7444,11.7853,109.1439}, 
	{470.5145,1212.8412,11.7957,108.0892}, 
	{471.0170,1217.4010,11.7930,109.9504}, 
	{471.4844,1221.8967,11.7938,108.1658}, 
	{472.0905,1227.2556,11.7955,108.3309}, 
	{482.1700,1225.9025,11.7873,241.7924}, 
	{481.0402,1221.3430,11.7869,241.0511}, 
	{480.5654,1216.4344,11.7954,242.0085}, 
	{479.9747,1211.5996,11.7890,239.6285}, 
	{479.8539,1206.4852,11.7867,237.9536}, 
	{478.8396,1202.0044,11.7922,239.5164}, 
	{478.5540,1196.9325,11.7891,238.4947}, 
	{477.8500,1192.2758,11.8096,241.4728}, 
	{477.3080,1187.6195,11.7934,241.6218}, 
	{376.1007,1178.4440,11.7867,170.4783}, 
	{372.6907,1178.9144,11.7867,169.9064}, 
	{368.6861,1179.4312,11.7867,172.1201}, 
	{365.1637,1180.0615,11.7867,171.4183}, 
	{414.8974,1173.9054,11.7867,173.5495}, 
	{418.7257,1173.4817,11.7867,173.7868}, 
	{422.3372,1172.6443,11.7867,170.4599}, 
	{425.7744,1172.1738,11.7867,172.6976}, 
	{477.3758,1156.5631,11.7941,352.3879}, 
	{472.7816,1156.9834,11.7941,353.5074}, 
	{481.6537,1156.1432,11.7941,350.4911}, 
	{486.2602,1165.3025,11.7867,84.1105}, 
	{486.7402,1170.1731,11.7871,80.1178}, 
	{487.3462,1174.8884,11.7867,81.8251}, 
	{487.8867,1179.7104,11.7867,80.8227}, 
	{488.3831,1184.7267,11.7904,80.3654}, 
	{488.9688,1189.7856,11.7867,83.8756}, 
	{489.4388,1194.5118,11.7867,81.2696}, 
	{489.8197,1199.4983,11.7867,81.4708}, 
	{490.4339,1204.1997,11.7867,80.3679}, 
	{490.8952,1208.1069,11.7885,80.2290}, 
	{491.2442,1211.9246,11.7941,80.3287}, 
	{491.7475,1215.7720,11.7941,81.5872}, 
	{492.0589,1219.4895,11.7941,82.7720}, 
	{492.5717,1223.2975,11.7867,79.7500}, 
	{492.8978,1227.1815,11.7867,79.9174}, 
	{493.3974,1230.9520,11.7867,79.1682}, 
	{494.0511,1234.6603,11.7867,80.5265}, 
	{494.4919,1238.3969,11.7867,81.4349}, 
	{494.9529,1242.1337,11.7896,81.3011}
};

static const Float:position_spawn_autosalon_3[][] =
{
	{2326.8621,-1774.2043,22.2403,178.4040}, 
	{2322.7334,-1773.7244,22.2401,175.6906}, 
	{2318.8518,-1773.9888,22.2308,176.7179}, 
	{2315.0437,-1773.7633,22.2405,178.2931}, 
	{2303.1926,-1773.5618,22.2374,269.6504}, 
	{2303.4827,-1793.4949,22.2405,270.0779}, 
	{2303.5984,-1797.7451,22.2416,270.6537}, 
	{2303.5503,-1801.8530,22.2410,269.2414}, 
	{2303.5369,-1806.1462,22.2411,270.1697}, 
	{2303.6709,-1810.3698,22.2416,271.7611}, 
	{2303.5063,-1814.5708,22.2416,270.3318}, 
	{2303.4270,-1818.6343,22.2468,270.9342}, 
	{2303.5522,-1822.9083,22.2480,269.7396}, 
	{2303.6301,-1827.0454,22.2477,269.4792}, 
	{2303.5149,-1831.3396,22.2473,269.0689}, 
	{2303.3835,-1835.4126,22.2507,267.9197}, 
	{2303.4312,-1839.5883,22.1933,270.0990}, 
	{2303.3181,-1843.9039,22.1929,268.1325}, 
	{2303.1821,-1848.2350,22.2323,270.1707}, 
	{2303.0950,-1851.8551,22.2425,269.7779}, 
	{2303.3972,-1855.3268,22.2409,266.9919}, 
	{2326.0950,-1842.9030,22.2403,89.2963}, 
	{2326.1882,-1838.9823,22.2404,90.1441}, 
	{2326.0598,-1835.3872,22.2409,89.0193}, 
	{2326.0608,-1831.7274,22.2415,89.2931}, 
	{2326.1650,-1828.0920,22.2414,88.7059}, 
	{2326.4465,-1824.5192,22.2407,88.8433}, 
	{2326.4783,-1820.9380,22.2342,89.7179}, 
	{2326.3938,-1817.2279,22.2407,89.7957}, 
	{2326.2087,-1813.9678,22.2406,88.8524}, 
	{2326.2075,-1810.5461,22.2406,88.7775}, 
	{2326.2837,-1795.4303,22.2406,92.7056}, 
	{2326.3513,-1791.2495,22.2172,93.8619}, 
	{2326.3440,-1787.2102,22.2404,92.6020}, 
	{2326.4387,-1783.4854,22.2424,90.8887}, 
	{2326.5752,-1857.2689,22.2400,1.6328}, 
	{2322.7761,-1857.2316,22.2401,1.9171}, 
	{2319.1252,-1857.0933,22.2401,3.4200}, 
	{2315.7231,-1857.1791,22.2401,2.6714}, 
	{2311.9976,-1857.2349,22.2401,0.8407}, 
	{2326.0959,-1846.2876,22.2401,90.2655}, 
	{2303.4951,-1789.0165,22.2401,268.5251}

};


stock create_family_other()
{
  	CreateDynamic3DTextLabel(""cWH"Семьи\n "cBLUE"Информация",-1, \
  	FAMILY_PICKUP, 5.0, INVALID_PLAYER_ID, INVALID_VEHICLE_ID, 0, -1);
	family_pickup = create_circle_pickup(FAMILY_PICKUP, TRIGGER_LBLUE);

	return true;
}

stock get_family_level(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_level");

	sql_free_result(r); 

	return type;
}

stock get_family_type(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_type");
	sql_free_result(r); 

	return type;
}

stock get_family_house(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_house");
	sql_free_result(r); 

	return type;
}

stock get_family_wh_status(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_wh_status");
	sql_free_result(r); 

	return type;
}

stock get_family_money(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_money");
	sql_free_result(r); 

	return type;
}

stock get_family_drugs(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_drugs");
	sql_free_result(r); 

	return type;
}

stock get_family_hdrugs(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_hdrugs");
	sql_free_result(r); 

	return type;
}

stock get_family_capacity(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_capacity");
	sql_free_result(r); 

	return type;
}

stock get_family_veh_capacity(family_ids)
{
	new 
		type,
		query[128];

	if(family_ids == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%i'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_veh_capacity");
	sql_free_result(r); 

	return type;
}

stock get_family_tag_type(family_ids)
{
	new 
		type,
		name[20],
		query[128];


	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", family_ids);
	new Result:r = sql_queryEx(zConn, query);

	type = sql_get_field_assoc_int_ex(r, 0, "family_type");
	sql_free_result(r); 
		
	switch(type)
	{
		case 0: name = "Семья";
		case 1: name = "Корпорация";
		case 2: name = "Синдикат";
		case 3: name = "Бригада";
		default: name = "Семья";
	}
	return name;
}

stock info_family_pickup(playerid)
{
    format(String512, sizeof(String512), "\
    "cGREY"Тип\t"cGREY"Информация\n\
    "cBLUE"- "cWH"Создать свою семью\t"cGR"%d"cWH" рублей\n\
    "cBLUE"- "cWH"Список семей\t"cWH"Всего: "cBLUE"%d"cWH" семей\n\
    "cBLUE"- "cWH"ТОП 10 семей по уровню\n\
    "cBLUE"- ТОП 10 игроков по рангу", PRICE_CREATE_FAMILY, get_all_family());
    return SPD(playerid, DIALOG_FAM_MENU_PICKUP, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Семьи", String512, !"Выбрать", !"Закрыть"); 
}

callback:: get_all_family()
{
	new Result:family_load = sql_queryEx(zConn, "SELECT * FROM `family` ORDER BY `family_id`", QUERY_CACHED);

	new all_family = sql_num_rows(family_load);

	return all_family;
}

stock dialog_create_family_1(playerid)
{

	if(pData[playerid][pFamily] != -1)
	{
		return SendErr(playerid, "У вас уже есть семья!");
	}

	format(String1024, sizeof(String1024), "\
	"cWH"У вас есть уникальная возможность создания семьи!\n\n\
	"cBLUE"- "cWH"Создавайте свою семью, продвигайте её и в будущем, Вы сможете заниматься\n\
	множеством не очень законных дел, которые смогут приносить денежные средства\n\
	Вашей семьи и продвигать её по влиянию только вверх!\n\n\
	"cBLUE"- "cWH"Стройте иерархию в семье, изменяйте наименование рангов в Вашей семье\n\
	разрешайте доступ к определенному функционалу только доверенным членам семьи!\n\n\
	"cBLUE"- "cWH"Когда Ваша семья будет развиваться, то Вы сможете улучшать её и присваивать\n\
	своей семье определенный статус, который прославит Вас в криминальных кругах и не только!\n\n\
	"cWH"Стоимость создания семьи "cGR"%d рублей"cWH", Вы хотите создать семью?", PRICE_CREATE_FAMILY);

	return SPD(playerid, DIALOG_CREATE_FAMILY_START, DIALOG_STYLE_MSGBOX, !""cBLUE"Создание семьи", String1024, !"Далее", !"Выход");

}

stock create_family_select_name(playerid)
{
	return SPD(playerid, DIALOG_CREATE_FAMILY_NAME, DIALOG_STYLE_INPUT, !""cBLUE"Название семьи", !"\
	"cWH"Название семьи - очень важный элемент при её создании!\n\n\
	Ведь все понимают, что во много решает название, ведь оно тоже задаёт статус\n\
	и вызывает уважение у остальных, так что постарайтесь выбрать действительно интересное\n\
	название для своей семьи!", !"Далее", !"Назад");
}

stock create_family_select_color(playerid)
{
    return SPD(playerid, DIALOG_CREATE_FAMILY_COLOR, DIALOG_STYLE_LIST, !""cBLUE"Выбор цвета семьи", "\
    {3366FF}Цвет №1\n\
    {6633FF}Цвет №2\n\
    {CC33FF}Цвет №3\n\
    {FF33CC}Цвет №4\n\
    {33CCFF}Цвет №5\n\
    {FF3366}Цвет №6\n\
    {33FFCC}Цвет №7\n\
    {B88A00}Цвет №8\n\
    {F5B800}Цвет №9\n\
    {FF6633}Цвет №10\n\
    {33FF66}Цвет №11\n\
   	{66FF33}Цвет №12\n\
    {CCFF33}Цвет №13\n\
    {E00000}Цвет №14\n\
    {660066}Цвет №15\n\
    {990000}Цвет №16\n\
    {999900}Цвет №17\n\
    {FFFF14}Цвет №18\n\
    {FF9966}Цвет №19\n\
    {FF6633}Цвет №20\n\
    "cWH"Цвет №21", !"Выбрать", !"Закрыть"); 
}

stock select_color_family_final(playerid, color_type)
{

	new query[128];
	format(query,sizeof(query),"SELECT `family_name` FROM `family` WHERE `family_name` = '%s'", family_create_name[playerid]);
	new Result:r = sql_queryEx(zConn, query);

	if(sql_num_rows(r))
	{
		SendErr(playerid, "Такое наименование семьи уже используется!");
		sql_free_result(r);
		return true;
	}
	sql_free_result(r);	

	family_create_color[playerid] = color_type;
 
    format(String512, sizeof(String512), "INSERT INTO family(family_owner_id, family_name, family_color) VALUES ('%d','%s','%d')",
    pData[playerid][pMysqlID], family_create_name[playerid], family_create_color[playerid]);
	new Result:hcreate = sql_queryEx(zConn, String512, QUERY_CACHED);
	
	new id = sql_insert_id(hcreate);
    sql_free_result(hcreate);


    pData[playerid][pFamily] = id;
    pData[playerid][pFamilyRank] = 7;

    UpdatePlayerData(playerid, "pFamily", pData[playerid][pFamily]);
    UpdatePlayerData(playerid, "pFamilyRank", pData[playerid][pFamilyRank]);

    final_create_family(playerid);
    return true;
}

stock final_create_family(playerid)
{

	new 
		id_family = pData[playerid][pFamily];



    create_family_label_text(playerid);
    update_family_label_text(playerid);


    give_money(playerid, -PRICE_CREATE_FAMILY, "Создание семьи");	

	format(String1024, sizeof(String1024), "\
	"cWH"Новая семья - новые возможности!\n\n\
	"cBLUE"- "cWH"Поздравляем Вас с созданием семьи!\n\
	Вас ждут новые горизонты и открытия, но не только Вас, но и членов Вашей семьи!\n\
	Желаем Вам удачи и Вашей "cBLUE"%s"cWH" семье!", get_family_name(id_family));

	SPD(playerid, 0, DIALOG_STYLE_MSGBOX, !""cBLUE"Новая семья", String1024, !"Далее", "");


	return true;
}

stock change_color_family_final(playerid, color_type)
{
	new 
		id_family = pData[playerid][pFamily];	

	format(String256, sizeof(String256), "UPDATE `family` SET \
		family_color = '%d'\
		WHERE family_id = '%d'",
		color_type,
		id_family);

	sql_queryEx(zConn, String256, QUERY_THREADED);	

	SendSucc(playerid, "Вы изменили цвет семьи");

	foreach(new i: logged_players)
	{
		if(!IsPlayerConnected(i)) continue;
		if(pData[i][pFamily] != id_family) continue;

		update_family_label_text(i);
	}

	return true;

}


CMD:family(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	new 
		fam_id = pData[playerid][pFamily];

	if(get_player_fam_owner(playerid, fam_id) || get_player_fam_zam(playerid, fam_id))
	{
		family_panel_owner(playerid);
	}
	else
	{
		family_panel_player(playerid);
	}

	return true;
}

stock get_player_fam_owner(playerid, fam_id)
{
	new 
		osnov_id,
		query[526];

	if(fam_id == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam_id);
	new Result:r = sql_queryEx(zConn, query);

	osnov_id = sql_get_field_assoc_int_ex(r, 0, "family_owner_id");
	sql_free_result(r);

	if(pData[playerid][pMysqlID] == osnov_id)
		return true;

	return false;
}

stock get_player_fam_zam(playerid, fam_id)
{
	new 
		zam_id,
		query[526];

	if(fam_id == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam_id);
	new Result:r = sql_queryEx(zConn, query);

	zam_id = sql_get_field_assoc_int_ex(r, 0, "family_c_owner_id");
	sql_free_result(r);

	if(pData[playerid][pMysqlID] == zam_id)
		return true;

	return false;
}

stock family_panel_warehouse(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	if(get_family_type(fam) < 1)
		return SendErr(playerid, "Вам недоступен общак семьи, требуется улучшение семьи!");

	format(String512, sizeof(String512), "\
		"cBLUE"- "cWH"Положить деньги\n\
		"cBLUE"- "cWH"Положить наркотики\n\
		"cBLUE"- "cWH"Положить тяжёлые наркотики\n\
		"cBLUE"- "cWH"Взять деньги\n\
		"cBLUE"- "cWH"Взять наркотики\n\
		"cBLUE"- "cWH"Взять тяжёлые наркотики\n\
		"cBLUE"- "cWH"%s общак", get_family_wh_status(fam) == 1 ? (""cGR"Открыть") : (""cLRED"Закрыть"));

	SPD(playerid, DIALOG_FAMILY_WAREHOUSE_LIST, DIALOG_STYLE_LIST, !""cBLUE"Общак семьи", String512, !"Выбрать", !"Закрыть");
	return true;
}

stock family_info_show(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	if(fam == -1)
		return true;

	new 
		osnov_id,
		zam_id,
		fam_date[20],
		fam_point,
		name_osnov[MAX_PLAYER_NAME],
		name_zam[MAX_PLAYER_NAME],
		fam_level,
		fam_house,
		fam_win,
		fam_lose,
		house_text[12],
		query[526];

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", pData[playerid][pFamily]);
	new Result:r = sql_queryEx(zConn, query);

	osnov_id = sql_get_field_assoc_int_ex(r, 0, "family_owner_id");
	zam_id = sql_get_field_assoc_int_ex(r, 0, "family_c_owner_id");
	sql_get_field_assoc_ex(r, 0, "family_create_date", fam_date);
	fam_point = sql_get_field_assoc_int_ex(r, 0, "family_point");
	fam_level = sql_get_field_assoc_int_ex(r, 0, "family_level");
	fam_house = sql_get_field_assoc_int_ex(r, 0, "family_house");
	fam_win = sql_get_field_assoc_int_ex(r, 0, "family_win");
	fam_lose = sql_get_field_assoc_int_ex(r, 0, "family_lose");
	sql_free_result(r);

	if(fam_house == -1)
	{
		format(house_text, sizeof(house_text), "Отсутствует");
	}
	else
	{
		format(house_text, sizeof(house_text), "%i", fam_house);
	}

	GetPlayerNameByID(osnov_id, name_osnov);
	GetPlayerNameByID(zam_id, name_zam);

	format(String1024, sizeof(String1024), "\
	"cWH"Семья: 		\t%s%s\n\
	"cWH"Тип:			\t"cBLUE"%s\n\
	"cWH"Дата основания: 	\t"cBLUE"%s\n\
	"cWH"Уровень семьи:	\t"cBLUE"%i\n\
	"cWH"Опыт:			\t"cBLUE"%i из %i\n\n\
	"cWH"Побед:			\t"cBLUE"%i\n\
	"cWH"Поражений:		\t"cBLUE"%i\n\n\
	"cWH"Семейный дом:	\t"cBLUE"%s\n\n\
	"cWH"Создатель: 		\t"cBLUE"%s\n\
	"cWH"Заместитель: 		\t"cBLUE"%s\n\
	"cWH"Участников: 		\t"cBLUE"%i\n\
	"cWH"В сети:			\t"cBLUE"%i\n\n\t\t\
	"cBLUE"[Общак семьи]\n\n\
	"cWH"Денег: 			\t"cGR"%i рублей\n\
	"cWH"Наркотиков: 		\t"cGR"%i/%i\n\
	"cWH"Тяжёлых наркотиков: 	\t"cGR"%i/%i\n\
	"cWH"Общак:			\t%s",
	get_color_family(fam),
	get_family_name(fam),
	get_family_tag_type(fam),
	fam_date,
	fam_level,
	fam_point,
	fam_level*FAMILY_POINT_COEFFCIENT,
	fam_win,
	fam_lose,
	house_text,
	name_osnov,
	name_zam,
	fam_members(fam),
	fam_members_online(fam),
	get_family_money(fam),
	get_family_drugs(fam), MAX_FAMILY_WAREHOUSE,
	get_family_hdrugs(fam), MAX_FAMILY_WAREHOUSE,
	get_family_wh_status(fam) == 1 ? (""cLRED"Закрыт") : (""cGR"Открыт"));
	return SPD(playerid, DIALOG_CLOSE_FAMILY, DIALOG_STYLE_MSGBOX, !""cBLUE"Информация о семье", String1024, !"Закрыть", "");	

}

stock update_player_kd(playerid)
{
	new
		Float:result, 
		Float:kills = pData[playerid][pFamilyKills],
		Float:deaths = pData[playerid][pFamilyDeaths];

	result = kills/deaths;

	pData[playerid][pFamilyKD] = result;

	new query[512];
	format(query,sizeof(query),"UPDATE `accounts` SET `pFamilyKD`='%.2f' WHERE `id`='%i'", result, pData[playerid][pMysqlID]);
	sql_queryEx(zConn, query, QUERY_THREADED);

	return true;
}

stock get_player_rang(playerid)
{
	new 
		rangname[32];
	
	if(pData[playerid][pFamilyKD] < 1)
	{
		rangname = "Новичок";
	}
	if(pData[playerid][pFamilyKD] >= 1)
	{
		rangname = "Перспективный";
	}
	if(pData[playerid][pFamilyKD] >= 2)
	{
		rangname = "Убийца";
	}
	if(pData[playerid][pFamilyKD] >= 2.5)
	{
		rangname = "Меткий";
	}
	if(pData[playerid][pFamilyKD] >= 3)
	{
		rangname = "Эксперт";
	}
	if(pData[playerid][pFamilyKD] >= 3.5)
	{
		rangname = "Громила";
	}
	if(pData[playerid][pFamilyKD] >= 4)
	{
		rangname = "Мастер";
	}
	if(pData[playerid][pFamilyKD] >= 4.5)
	{
		rangname = "Тащер";
	}
	if(pData[playerid][pFamilyKD] >= 5)
	{
		rangname = "Монстр";
	}
	if(pData[playerid][pFamilyKD] >= 5.5)
	{
		rangname = "Король";
	}
	return rangname;
}

stock get_player_rang_by_id(sql_id)
{
	new 
		Float:kd,
		rangname[32],
		query[526];

	format(query,sizeof(query),"SELECT * FROM `accounts` WHERE `id` = '%d'", sql_id);
	new Result:r = sql_queryEx(zConn, query);

	kd = sql_get_field_assoc_float_ex(r, 0, "pFamilyKD");
	sql_free_result(r);
	if(kd < 1)
	{
		rangname = "Новичок";
	}
	if(kd >= 1)
	{
		rangname = "Перспективный";
	}
	if(kd >= 2)
	{
		rangname = "Убийца";
	}
	if(kd >= 2.5)
	{
		rangname = "Меткий";
	}
	if(kd >= 3)
	{
		rangname = "Эксперт";
	}
	if(kd >= 3.5)
	{
		rangname = "Громила";
	}
	if(kd >= 4)
	{
		rangname = "Мастер";
	}
	if(kd >= 4.5)
	{
		rangname = "Тащер";
	}
	if(kd >= 5)
	{
		rangname = "Монстр";
	}
	if(kd >= 5.5)
	{
		rangname = "Король";
	}
	return rangname;
}

stock family_install_house(playerid)
{
	new 
		fam_id = pData[playerid][pFamily],
		fam_house,
		query[256];

	if(fam_id == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam_id);
	new Result:r = sql_queryEx(zConn, query);

	fam_house = sql_get_field_assoc_int_ex(r, 0, "family_house");
	sql_free_result(r);

	if(!get_player_fam_owner(playerid, fam_id))
		return SendErr(playerid, "Вам недоступна данная функция");

	if(!IsAFamilyHouse(playerid))
		return SendErr(playerid, "Вы не владеете домом в посёлке Леон");

	if(pData[playerid][pHouse] == fam_house)
		return SendErr(playerid, "Дом семьи уже установлен");

	format(String256, sizeof(String256), "UPDATE `family` SET \
    	family_house = '%i'\
    	WHERE family_id = '%i'",
    	pData[playerid][pHouse],
    	fam_id);

	sql_queryEx(zConn, String256, QUERY_THREADED);

	format(String144, sizeof(String144), "Вы установили семейным домом %i", pData[playerid][pHouse]);
	SendSucc(playerid, String144);

	return true;
}

stock IsAFamilyHouse(playerid)
{
	if(pData[playerid][pHouse] >= 66 && pData[playerid][pHouse] < 96)
		return true;
	return false;
}

stock family_panel_owner(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");


	new
		fam_id = pData[playerid][pFamily],
		fam_invite,
		fam_uninvite,
		fam_rank,
		query[526];

	if(fam_id == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", pData[playerid][pFamily]);
	new Result:r = sql_queryEx(zConn, query);

	fam_invite =  sql_get_field_assoc_int_ex(r, 0, "family_level_invite_rank");
	fam_uninvite = sql_get_field_assoc_int_ex(r, 0, "family_level_uninvite_rank");
	fam_rank = sql_get_field_assoc_int_ex(r, 0, "family_level_give_rank");
	sql_free_result(r);

    format(String2048, sizeof(String2048), "\
    "cGREY"Тип\t"cGREY"Информация\n\
    "cBLUE"- "cWH"Информация о семье\t"cBLUE"Открыть\n\
    "cBLUE"\t\n\
    "cBLUE"- "cWH"Семейный дом\t"cBLUE"Установить\n\
    "cBLUE"- "cWH"Улучшение семьи\t"cBLUE"Улучшить\n\
    "cBLUE"- "cWH"Изменение названия семьи\t"cBLUE"Изменить\n\
    "cBLUE"- "cWH"Изменение наименования рангов\t"cBLUE"Изменить\n\
    "cBLUE"- "cWH"Изменение приветствия при входе\t"cBLUE"Изменить\n\
    "cBLUE"- "cWH"Изменение цвета семьи\t"cBLUE"Изменить\n\
    "cBLUE"- "cWH"Изменение доступа к принятию в семью\t"cBLUE"Доступно с %s (Ранг: %d)\n\
    "cBLUE"- "cWH"Изменение доступа к увольнению из семьи\t"cBLUE"Доступно с %s (Ранг: %d)\n\
    "cBLUE"- "cWH"Изменение доступа к повышению в семье\t"cBLUE"Доступно с %s (Ранг: %d)\n\
    "cBLUE"\t\n\
    "cBLUE"- "cWH"Общак семьи\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Семейный транспорт\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Список членов семьи\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Члены семьи онлайн\t"cBLUE"Открыть",
    get_rang_family(fam_id, fam_invite), fam_invite+1,
    get_rang_family(fam_id, fam_uninvite), fam_uninvite+1,
    get_rang_family(fam_id, fam_rank), fam_rank+1);
    return SPD(playerid, DIALOG_CHANGE_FAMILY_OWNER, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Управление семьей", String2048, !"Выбрать", !"Закрыть"); 
}

stock family_panel_player(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

    format(String512, sizeof(String512), "\
    "cGREY"Тип\t"cGREY"Информация\n\
    "cBLUE"- "cWH"Информация о семье\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Общак семьи\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Семейный транспорт\t"cBLUE"Открыть\n\
    "cBLUE"- "cWH"Все члены семьи"cBLUE"\tОткрыть\n\
    "cBLUE"- "cWH"Все члены семьи онлайн\t"cBLUE"Открыть\n\
    "cBLUE"\t\n\
    "cBLUE"- "cWH"Уйти из семьи");
    return SPD(playerid, DIALOG_CHANGE_FAMILY_OTHER, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Управление семьей", String512, !"Выбрать", !"Закрыть"); 
}

stock select_giverank_player(playerid, playerid_giverank)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily];

	SetPVarIntNew(playerid, "family_giverank_id", playerid_giverank);

    format(String1024, sizeof(String1024), "\
    "cGREY"Ранг\t"cGREY"Действие\n\
    "cBLUE"1. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"2. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"3. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"4. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"5. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"6. "cWH"%s\t"cBLUE"Выбрать\n\
    "cBLUE"7. "cWH"%s\t"cBLUE"Выбрать", 
    get_rang_family(fam, 0),
    get_rang_family(fam, 1),
    get_rang_family(fam, 2),
    get_rang_family(fam, 3),
    get_rang_family(fam, 4),
    get_rang_family(fam, 5),
    get_rang_family(fam, 6));
    return SPD(playerid, DIALOG_CHANGE_RANK_FAM_P, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Управление семьей", String1024, !"Выбрать", !"Закрыть"); 
}

stock give_player_rank_family(playerid, rank)
{
	new 
		fam_id = pData[playerid][pFamily],
		fam_1 = pData[playerid][pFamilyRank],
		rank_give_id = GetPVarIntNew(playerid, "family_giverank_id");

	if(pData[rank_give_id][pFamilyRank] == rank)
		return SendErr(playerid, "Член семьи и так имеет данный ранг!");


	pData[rank_give_id][pFamilyRank] = rank+1;
	UpdatePlayerData(rank_give_id, "pFamilyRank", pData[rank_give_id][pFamilyRank]);	

	format(String256, sizeof(String256), "%s[%s %s] Ранг %s [%d] был изменен на '%s' %s %s [%d]",  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), 
		pData[rank_give_id][pNickname], rank_give_id, get_rang_family(rank_give_id, fam_1),
		get_rang_family(fam_id, fam_1), pData[playerid][pNickname], playerid);
	send_family_chat(fam_id, String256);	

	return true;
}

stock family_change_name(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	format(String256, sizeof(String256), "\n\
		"cWH"Введите новое название для своей семьи\n\
		"cWH"Название семьи должно быть уникальным\n\
		"cWH"Стоимость изменения названия: "cGR"%i донат рублей\n\n\
		"cWH"На Вашем счету: "cBLUE"%i донат рублей"
		, PRICE_CHANGE_FAMILY_NAME, pData[playerid][pDonate]);

	return SPD(playerid, DIALOG_CHANGE_FAMILY_NAME, DIALOG_STYLE_INPUT, !""cBLUE"Изменение названия семьи", String256, !"Изменить", !"Закрыть");
}

stock family_upgrade_main(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam_id = pData[playerid][pFamily];

	format(String1024, sizeof(String1024), "\
	"cGREY"Улучшение\t"cGREY"Стоимость\t"cGREY"Статус\n\
	"cBLUE"- "cWH"Тип семьи: 'Корпорация'\t"cBLUE"5 уровень семьи, %i руб\t%s\n\
	"cBLUE"- "cWH"Тип семьи: 'Синдикат'\t"cBLUE"10 уровень семьи, %i руб\t%s\n\
	"cBLUE"- "cWH"Тип семьи: 'Бригада'\t"cBLUE"15 уровень семьи, %i руб\t%s\n\
	"cBLUE"- "cWH"Увеличить вместимость семьи до 50 человек\t"cBLUE"%i руб\t%s\n\
	"cBLUE"- "cWH"Увеличить автопарк семьи до 8 машин\t"cBLUE"%i руб\t%s\n\
	"cBLUE"- "cWH"Информация об улучшениях",
	 PRICE_FAMILY_UPGRADE_CORP, get_family_type(fam_id) >= 1 ? (""cGR"[Куплено]") : (""cLRED"[Не куплено]"),
	 PRICE_FAMILY_UPGRADE_SYNDICATE, get_family_type(fam_id) >= 2 ? (""cGR"[Куплено]") : (""cLRED"[Не куплено]"),
	 PRICE_FAMILY_UPGRADE_BRIGADE, get_family_type(fam_id) >= 3 ? (""cGR"[Куплено]") : (""cLRED"[Не куплено]"),
	 PRICE_FAMILY_UPGRADE_CAPACITY, get_family_capacity(fam_id) == 1 ? (""cGR"[Куплено]") : (""cLRED"[Не куплено]"),
	 PRICE_FAMILY_UPGRADE_VEHICLE, get_family_veh_capacity(fam_id) == 1 ? (""cGR"[Куплено]") : (""cLRED"[Не куплено]"));

	SPD(playerid, DIALOG_UPGRADE_FAMILY, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Улучшение семьи", String1024, !"Выбрать", !"Назад");
	return true;
}

stock family_change_name_rank(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily];


    format(String1024, sizeof(String1024), "\
    "cGREY"Ранг\t"cGREY"Действие\n\
    "cBLUE"1. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"2. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"3. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"4. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"5. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"6. "cWH"%s\t"cBLUE"Изменить\n\
    "cBLUE"7. "cWH"%s\t"cBLUE"Изменить", 
    get_rang_family(fam, 0),
    get_rang_family(fam, 1),
    get_rang_family(fam, 2),
    get_rang_family(fam, 3),
    get_rang_family(fam, 4),
    get_rang_family(fam, 5),
    get_rang_family(fam, 6));
    return SPD(playerid, DIALOG_CHANGE_FAMILY_NAME_RANK, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Управление семьей", String1024, !"Выбрать", !"Закрыть"); 

}

stock change_name_rank_family(playerid, type)
{
	new 
		fam = pData[playerid][pFamily];

	SetPVarIntNew(playerid, "get_change_fam_rank", type);

	format(String256, sizeof(String256), "\
	"cWH"Введите новое наименование для %d ранга в семье\n\n\
	"cWH"Текущее наименование ранга: "cBLUE"%s\n\n\
	От 5 до 24 символов", type+1, get_rang_family(fam, type));

	return SPD(playerid, DIALOG_CHANGE_FAMILE_RANK_INPUT, DIALOG_STYLE_INPUT, !""cBLUE"Наименование ранга", String256, !"Далее", !"Назад");
}


stock family_change_message(playerid)
{
	new 
		fam = pData[playerid][pFamily],
		fam_message[32],
		query[144];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:r = sql_queryEx(zConn, query);

	sql_get_field_assoc_ex(r, 0, "family_message", fam_message);

	sql_free_result(r);

	format(String256, sizeof(String256), "\
	"cWH"Введите новое уведомление для семьи при входе\n\n\
	"cWH"Текущее: "cBLUE"%s\n\n\
	От 5 до 32 символов", fam_message);

	return SPD(playerid, DIALOG_CHANGE_FAMILE_MES_INPUT, DIALOG_STYLE_INPUT, !""cBLUE"Изменение приветствия", String256, !"Далее", !"Назад");
}


stock family_change_rank_invite(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily],
		fam_inv_rank,
		query[144];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", pData[playerid][pFamily]);
	new Result:r = sql_queryEx(zConn, query);

	fam_inv_rank = sql_get_field_assoc_int_ex(r, 0, "family_level_invite_rank");

	sql_free_result(r);

    format(String1024, sizeof(String1024), "\
    "cBLUE"Приглашение в семью доступно с %s (%d ранг)\n\n\
    "cBLUE"1. "cWH"%s\n\
    "cBLUE"2. "cWH"%s\n\
    "cBLUE"3. "cWH"%s\n\
    "cBLUE"4. "cWH"%s\n\
    "cBLUE"5. "cWH"%s\n\
    "cBLUE"6. "cWH"%s\n\
    "cBLUE"7. "cWH"%s",
    get_rang_family(fam, fam_inv_rank),
    fam_inv_rank+1,
    get_rang_family(fam, 0),
    get_rang_family(fam, 1),
    get_rang_family(fam, 2),
    get_rang_family(fam, 3),
    get_rang_family(fam, 4),
    get_rang_family(fam, 5),
    get_rang_family(fam, 6));
    return SPD(playerid, DIALOG_CHANGE_FAM_RANK_INV, DIALOG_STYLE_LIST, !""cBLUE"Управление семьей", String1024, !"Выбрать", !"Закрыть"); 

}

stock change_invite_rank_family(playerid, type)
{

	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256), "UPDATE `family` SET \
		family_level_invite_rank = '%d'\
		WHERE family_id = '%d'",
		type,
		fam);

	sql_queryEx(zConn, String256, QUERY_THREADED);

	SendSucc(playerid, "Вы изменили доступ к приглашению в семью");

	return family_change_rank_invite(playerid);
}

stock family_change_rank_uninvite(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily],
		fam_uninv_rank,
		query[144];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", pData[playerid][pFamily]);
	new Result:r = sql_queryEx(zConn, query);

	fam_uninv_rank = sql_get_field_assoc_int_ex(r, 0, "family_level_uninvite_rank");

	sql_free_result(r);

    format(String1024, sizeof(String1024), "\
    "cBLUE"Увольнение из семьи доступно с %s (%d ранг)\n\n\
    "cBLUE"1. "cWH"%s\n\
    "cBLUE"2. "cWH"%s\n\
    "cBLUE"3. "cWH"%s\n\
    "cBLUE"4. "cWH"%s\n\
    "cBLUE"5. "cWH"%s\n\
    "cBLUE"6. "cWH"%s\n\
    "cBLUE"7. "cWH"%s",
    get_rang_family(fam, fam_uninv_rank),
    fam_uninv_rank+1,
    get_rang_family(fam, 0),
    get_rang_family(fam, 1),
    get_rang_family(fam, 2),
    get_rang_family(fam, 3),
    get_rang_family(fam, 4),
    get_rang_family(fam, 5),
    get_rang_family(fam, 6));
    return SPD(playerid, DIALOG_CHANGE_FAM_RANK_UNINV, DIALOG_STYLE_LIST, !""cBLUE"Управление семьей", String1024, !"Выбрать", !"Закрыть"); 

}

stock change_uninvite_rank_family(playerid, type)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256), "UPDATE `family` SET \
		family_level_uninvite_rank = '%d'\
		WHERE family_id = '%d'",
		type,
		fam);

	sql_queryEx(zConn, String256, QUERY_THREADED);

	SendSucc(playerid, "Вы изменили доступ к увольнению из семьи");

	return family_change_rank_uninvite(playerid);
}

stock family_change_rank_giverank(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily],
		fam_give_rank,
		query[144];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", pData[playerid][pFamily]);
	new Result:r = sql_queryEx(zConn, query);

	fam_give_rank = sql_get_field_assoc_int_ex(r, 0, "family_level_give_rank");

	sql_free_result(r);

    format(String1024, sizeof(String1024), "\
    "cBLUE"Изменение ранга доступно с %s (%d ранг)\n\n\
    "cBLUE"1. "cWH"%s\n\
    "cBLUE"2. "cWH"%s\n\
    "cBLUE"3. "cWH"%s\n\
    "cBLUE"4. "cWH"%s\n\
    "cBLUE"5. "cWH"%s\n\
    "cBLUE"6. "cWH"%s\n\
    "cBLUE"7. "cWH"%s",
    get_rang_family(fam, fam_give_rank),
    fam_give_rank+1,
    get_rang_family(fam, 0),
    get_rang_family(fam, 1),
    get_rang_family(fam, 2),
    get_rang_family(fam, 3),
    get_rang_family(fam, 4),
    get_rang_family(fam, 5),
    get_rang_family(fam, 6));
    return SPD(playerid, DIALOG_CHANGE_FAMILY_GIVE_RANK, DIALOG_STYLE_LIST, !""cBLUE"Управление семьей", String1024, !"Выбрать", !"Закрыть"); 

}

stock change_give_rank_family(playerid, type)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи!");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256), "UPDATE `family` SET \
		family_level_give_rank = '%d'\
		WHERE family_id = '%d'",
		type,
		fam);

	sql_queryEx(zConn, String256, QUERY_THREADED);

	SendSucc(playerid, "Вы изменили доступ к изменению ранга");

	return family_change_rank_giverank(playerid);	
}

stock family_all_player_online(playerid)
{
	new 
		count_family;

	format(String2048, sizeof(String2048), ""cGREY"№. Никнейм\t"cGREY"Уровень\t"cGREY"Ранг\n");

	foreach(new i: logged_players)
	{
		if(pData[i][pFamily] == pData[playerid][pFamily]) 
		{
			format(String2048,sizeof(String2048),"%s"cBLUE"%i."cWH" %s\t%d\t%s\n", String2048, 
				count_family+1, 
				pData[i][pNickname], 
				pData[i][pLevel], 
				get_rang_family(pData[playerid][pFamily], pData[i][pFamilyRank]-1));
			count_family++;
		}
	}
	SPD(playerid, DIALOG_CLOSE_FAMILY, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Семья онлайн", String2048, !"Назад","");
	return true;
}

stock buy_family_car(playerid, type_autosalon, modelid, c1, c2, price)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи");

	if(pData[playerid][pFamilyRank] != 7)
		return SendErr(playerid, "Вам запрещено пользоваться данным функционалом!");

	new 
		fam_id = pData[playerid][pFamily];

	if(get_family_type(fam_id) == 1 && type_autosalon == BUISNES_AUTOSALON_2)
		return SendErr(playerid, "Уровень семьи недостаточен для покупки автомобиля в Элитном автосалоне!");
	if(get_family_type(fam_id) == 0 && type_autosalon == BUISNES_AUTOSALON_2)
		return SendErr(playerid, "Уровень семьи недостаточен для покупки автомобиля в Элитном автосалоне!");
 
	if(get_family_type(fam_id) == 0 && type_autosalon == BUISNES_AUTOSALON_1)
		return SendErr(playerid, "Уровень семьи недостаточен для покупки автомобиля в автосалоне Среднего класса!");



	new 
		random_pos;

	if(get_family_vehilces_count(fam_id) >= MAX_FAMILY_VEHICLES_1 && get_family_veh_capacity(fam_id) == 0)
		return SendErr(playerid, "В семье недостаточно слотов под транспорт");

	if(get_family_vehilces_count(fam_id) >= MAX_FAMILY_VEHICLES_2 && get_family_veh_capacity(fam_id) == 1)
		return SendErr(playerid, "В семье недостаточно слотов под транспорт");

	if(GetPlayerMoneyEx(playerid) < price)
	{
		show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
		return SendErr(playerid, "У Вас недостаточно денег для покупки");
	}

	new 
		fmt_str[144];

	format(fmt_str, sizeof(fmt_str), "%s[%s %s] %s приобрел семейный транспорт '%s'",  
		get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), pData[playerid][pNickname], transport_config[modelid-400][transport_name]);
	send_family_chat(fam_id, fmt_str);

	SendSucc(playerid, "Вы купили семейный транспорт");

	SPD(playerid, 0, DIALOG_STYLE_MSGBOX, !""cBLUE"Семейный транспорт", "\n\
		"cWH"Вы приобрели семейный транспорт!\n\n\
		"cBLUE"[Список доступных команд]\n\
		"cBLUE"- "cWH"/fcar - Управление семейным транспортом\n\
		"cBLUE"- "cWH"/fpark - Припарковать семейное тс\n\
		"cBLUE"- "cWH"/flock - Открыть/закрыть семейный транспорт\n"
		, !"Закрыть", "");

	if(type_autosalon == BUISNES_AUTOSALON_1)
	{
		random_pos = random(20);

		format(String1024,sizeof(String1024),"INSERT INTO `family_vehicles`(`family_id`,`model`,`color_1`,`color_2`, `parking_x`,`parking_y`,`parking_z`,`parking_a`, `parking_vw`) VALUES ('%i','%i','%i','%i','%f','%f','%f','%f', '%i')", fam_id, modelid,
		c1, c2, position_spawn_autosalon_1[random_pos][0], position_spawn_autosalon_1[random_pos][1], position_spawn_autosalon_1[random_pos][2], position_spawn_autosalon_1[random_pos][3], 0);
		sql_queryEx(zConn, String1024, QUERY_THREADED);

		give_money(playerid, -transport_config[modelid-400][transport_price] ,"Приобретение автомобиля в Арзамас Карс");
		buisness_bank_update(BUISNES_AUTOSALON_1, floatround(transport_config[modelid-400][transport_price]*0.2), "Приобретение семейного автомобиля в «АрзамасКарс»");

	}
	else if(type_autosalon == BUISNES_AUTOSALON_2)
	{
		random_pos = random(10);

		format(String1024,sizeof(String1024),"INSERT INTO `family_vehicles`(`family_id`,`model`,`color_1`,`color_2`, `parking_x`,`parking_y`,`parking_z`,`parking_a`, `parking_vw`) VALUES ('%i','%i','%i','%i','%f','%f','%f','%f', '%i')", fam_id, modelid,
		c1, c2, position_spawn_autosalon_2[random_pos][0], position_spawn_autosalon_2[random_pos][1], position_spawn_autosalon_2[random_pos][2], position_spawn_autosalon_2[random_pos][3], 0);
		sql_queryEx(zConn, String1024, QUERY_THREADED);

		give_money(playerid, -transport_config[modelid-400][transport_price] ,"Приобретение автомобиля в «АвтоХаус»");
		buisness_bank_update(BUISNES_AUTOSALON_2, floatround(transport_config[modelid-400][transport_price]*0.2), "Приобретение семейного автомобиля в «АвтоХаус»");

	}
	else if(type_autosalon == BUISNES_AUTOSALON_3)
	{
		random_pos = random(10);

		format(String1024,sizeof(String1024),"INSERT INTO `family_vehicles`(`family_id`,`model`,`color_1`,`color_2`, `parking_x`,`parking_y`,`parking_z`,`parking_a`, `parking_vw`) VALUES ('%i','%i','%i','%i','%f','%f','%f','%f', '%i')", fam_id, modelid,
		c1, c2, position_spawn_autosalon_3[random_pos][0], position_spawn_autosalon_3[random_pos][1], position_spawn_autosalon_3[random_pos][2], position_spawn_autosalon_3[random_pos][3], 0);
		sql_queryEx(zConn, String1024, QUERY_THREADED);		

		give_money(playerid, -transport_config[modelid-400][transport_price] ,"Приобретение автомобиля в «АвтодВОР»");
		buisness_bank_update(BUISNES_AUTOSALON_3, floatround(transport_config[modelid-400][transport_price]*0.2), "Приобретение семейного автомобиля в «АвтодВОР»");

	}

	return true;
}

stock family_all_player(playerid)
{
	format(String512, sizeof(String512), "SELECT * FROM `accounts` WHERE `pFamily` = '%d'", pData[playerid][pFamily]);
	new Result:family_offline_load = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_fam_offline = sql_num_rows(family_offline_load);

	new 
		name_fam_off[MAX_PLAYER_NAME],
		last_connect[32],
		level_fam_off,
		rang_fam_off;

	part_family_offline[playerid] = 0;

	format(String2048, sizeof(String2048), ""cGREY"№.Никнейм\t"cGREY"Уровень\t"cGREY"Ранг\t"cGREY"Последний вход\n");

 	for(new i; i < all_fam_offline; i++)
	{

		sql_get_field_assoc_ex(family_offline_load, i,"nickname", name_fam_off, MAX_PLAYER_NAME);

		sql_get_field_assoc_ex(family_offline_load, i,"last", last_connect, 32);

		level_fam_off  = sql_get_field_assoc_int_ex(family_offline_load, i, "level");
		rang_fam_off  = sql_get_field_assoc_int_ex(family_offline_load, i, "pFamilyRank");  

		format(String2048, sizeof(String2048), "%s"cBLUE"%i."cWH" %s\t%d\t%s\t%s\n", String2048, i+1, name_fam_off, level_fam_off, get_rang_family(pData[playerid][pFamily], rang_fam_off-1), last_connect);
	}
	SPD(playerid, 0, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Состав семьи", String2048, !"Закрыть","");
	sql_free_result(family_offline_load);


	return true;
}


stock check_all_family_server(playerid)
{

	format(String512, sizeof(String512), "SELECT * FROM `family`");
	new Result:family_all_load = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_fam_offline = sql_num_rows(family_all_load);

	if(!all_fam_offline)
		return SendErr(playerid, "Семьи не найдены");

	new 
		string[2048],
		fam_id,
		fam_name_all[32];

 	for(new i; i < all_fam_offline; i++)
	{
		fam_id = sql_get_field_assoc_int_ex(family_all_load, i, "family_id"); 

		sql_get_field_assoc_ex(family_all_load, i, "family_name", fam_name_all, 20);

		format(string, sizeof(string), "%s\n"cBLUE"- %s%s", string, get_color_family(fam_id), fam_name_all);
	}

	SPD(playerid, DIALOG_FAMILY_INFO, DIALOG_STYLE_LIST, !""cBLUE"Список семей", string, !"Выбрать", !"Назад");

	sql_free_result(family_all_load);	
	return true;
}

callback:: check_top_famiy_server(playerid)
{
	format(String512, sizeof(String512), "SELECT * FROM `family`  WHERE `family_level` > 1 ORDER BY `family_level` DESC LIMIT 10");
	new Result:family_top_load = sql_queryEx(zConn, String512, QUERY_CACHED);

	new 
		count = sql_num_rows(family_top_load),
		fam_id,
		fam_level,
		fam_point,
		fam_name_all[32];

	if(!count)
		return SendErr(playerid, "Топ семей не сформирован");

	format(String1024, sizeof(String1024), ""cGREY"Семья\t"cGREY"Уровень\t"cGREY"Опыт\n");

	for(new i; i < count; i++)
	{
		fam_id = sql_get_field_assoc_int_ex(family_top_load, i, "family_id"); 

		fam_level = sql_get_field_assoc_int_ex(family_top_load, i, "family_level");
		fam_point = sql_get_field_assoc_int_ex(family_top_load, i, "family_point");

		sql_get_field_assoc_ex(family_top_load, i, "family_name", fam_name_all);

		format(String1024, sizeof(String1024), "%s"cBLUE"- %s%s\t"cWH"%i\t%i из %i\n", String1024, get_color_family(fam_id), fam_name_all, fam_level, fam_point, fam_level * FAMILY_POINT_COEFFCIENT);
	}
	SPD(playerid, DIALOG_FAMILY_INFO, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"ТОП 10 семей", String1024, !"Выбрать", !"Назад");

	sql_free_result(family_top_load);
	return true;
}

callback:: check_top_war_family_server(playerid)
{
	format(String512, sizeof(String512), "SELECT * FROM `accounts` WHERE `pFamilyKD` > 1 ORDER BY `pFamilyKD` DESC LIMIT 10");
	new Result:family_top_load = sql_queryEx(zConn, String512, QUERY_CACHED);

	new 
		count = sql_num_rows(family_top_load),
		name[24],
		sql_id,
		fam_id,
		Float:kd;

	if(!count)
		return SendErr(playerid, "Топ семей не сформирован");

	format(String1024, sizeof(String1024), ""cGREY"Никнейм\t"cGREY"Семья\t"cGREY"Счёт\t"cGREY"Ранг\n");

	for(new i; i < count; i++)
	{
		sql_get_field_assoc_ex(family_top_load, i, "nickname", name); 

		kd = sql_get_field_assoc_float_ex(family_top_load, i, "pFamilyKD");

		sql_id = sql_get_field_assoc_int_ex(family_top_load, i, "id");
		fam_id = sql_get_field_assoc_int_ex(family_top_load, i, "pFamily");

		format(String1024, sizeof(String1024), "%s"cBLUE"%i. "cWH"%s\t"cWH"%s\t"cWH"%.2f\t"cWH"%s\n", String1024, i+1, name, get_family_name(fam_id), kd, get_player_rang_by_id(sql_id));
	}
	SPD(playerid, 0, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"ТОП 10 игроков", String1024, !"Закрыть", "");

	sql_next_row(family_top_load);
	return true;
}

callback:: show_family_war_family_list(playerid)
{
	format(String512, sizeof(String512), "SELECT * FROM `family`  WHERE `family_type` > 1 ORDER BY `family_id`");
	new Result:family_top_load = sql_queryEx(zConn, String512, QUERY_CACHED);

	new 
		count = sql_num_rows(family_top_load),
		fam_id,
		fam_win,
		fam_lose,
		fam_name_all[32];

	if(!count)
		return SendErr(playerid, "Список не сформирован");

	format(String2048, sizeof(String2048), ""cGREY"Семья\t"cGREY"Побед\t"cGREY"Поражений\n");

	for(new i; i < count; i++)
	{
		fam_id = sql_get_field_assoc_int_ex(family_top_load, i, "family_id"); 

		fam_win = sql_get_field_assoc_int_ex(family_top_load, i, "family_win");
		fam_lose = sql_get_field_assoc_int_ex(family_top_load, i, "family_lose");

		sql_get_field_assoc_ex(family_top_load, i, "family_name", fam_name_all);

		format(String2048, sizeof(String2048), "%s"cBLUE"%i. %s%s\t"cWH"%i\t%i\n", String2048, i+1, get_color_family(fam_id), fam_name_all, fam_win, fam_lose);
	}
	SPD(playerid, DIALOG_FAMILY_WAR_INFO, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Война семей", String2048, !"Выбрать", !"Закрыть");

	sql_next_row(family_top_load);

	return true;
}

stock change_family_select_color(playerid)
{
    format(String512, sizeof(String512), "\
    {3366FF}Цвет №1\n\
    {6633FF}Цвет №2\n\
    {CC33FF}Цвет №3\n\
    {FF33CC}Цвет №4\n\
    {33CCFF}Цвет №5\n\
    {FF3366}Цвет №6\n\
    {33FFCC}Цвет №7\n\
    {B88A00}Цвет №8\n\
    {F5B800}Цвет №9\n\
    {FF6633}Цвет №10\n\
    {33FF66}Цвет №11\n\
   	{66FF33}Цвет №12\n\
    {CCFF33}Цвет №13\n\
    {E00000}Цвет №14\n\
    {660066}Цвет №15\n\
    {990000}Цвет №16\n\
    {999900}Цвет №17\n\
    {FFFF14}Цвет №18\n\
    {FF9966}Цвет №19\n\
    {FF6633}Цвет №20\n\
    "cWH"Цвет №21");
    return SPD(playerid, DIALOG_FAMILY_CHANGE_COLOR, DIALOG_STYLE_LIST, !""cBLUE"Выбор цвета семьи", String512, !"Выбрать", !"Закрыть"); 	

}

stock family_player_leave_prew(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье!");

	if(get_player_fam_owner(playerid, pData[playerid][pFamily]) || get_player_fam_zam(playerid, pData[playerid][pFamily]))
		return SendErr(playerid, "Вы не можете покинуть семью!");

	return SPD(playerid, DIALOG_LEAVE_FAMILY_FINAL, DIALOG_STYLE_MSGBOX, !""cBLUE"Уход из семьи", !"\
	"cWH"Вы уверены, что хотите покинуть семью?", !"Да", !"Нет");
}

stock family_player_leave_final(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье!");

	if(get_player_fam_owner(playerid, pData[playerid][pFamily]) || get_player_fam_zam(playerid, pData[playerid][pFamily]))
		return SendErr(playerid, "Вы не можете покинуть семью!");

	new 
		fam_id = pData[playerid][pFamily],
		fam_rank = pData[playerid][pFamilyRank]-1;

	format(String256, sizeof(String256), "%s[%s] %s %s [%d] покинул семью!", get_color_family(fam_id), get_family_name(fam_id), get_rang_family(fam_id, fam_rank), pData[playerid][pNickname], playerid);
	send_family_chat(pData[playerid][pFamily], String256);

	SendSucc(playerid, "Вы успешно покинули семью!");

	pData[playerid][pFamily] = -1;
	pData[playerid][pFamilyRank] = -1;

    UpdatePlayerData(playerid, "pFamily", pData[playerid][pFamily]);
    UpdatePlayerData(playerid, "pFamilyRank", pData[playerid][pFamilyRank]);

    clear_family_label_text(playerid);

	return true;
}

stock get_family_name(fam)
{
	new 
		fam_name[32],
		query[128];


	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:r = sql_queryEx(zConn, query);

	sql_get_field_assoc_ex(r, 0, "family_name", fam_name);
	sql_free_result(r);

	return fam_name;
}

stock accept_invite_family(playerid, playerid_invite)
{
	if(pData[playerid_invite][pFamily] != -1)
		return SendErr(playerid, "Игрок уже состоит в семье!");

	
	new 
		fam_id = pData[playerid][pFamily],
		fam_rank = pData[playerid][pFamilyRank]-1;

	pData[playerid_invite][pFamily] = fam_id;
	pData[playerid_invite][pFamilyRank] = 1;
 
    UpdatePlayerData(playerid_invite, "pFamily", pData[playerid_invite][pFamily]+1);
    UpdatePlayerData(playerid_invite, "pFamilyRank", pData[playerid_invite][pFamilyRank]);

    new 
    	fam_rank_invite = pData[playerid_invite][pFamilyRank]-1;

	format(String256, sizeof(String256), "%s[%s] %s %s [%d] был приглашен в семью %s %s [%d]",  
		get_color_family(fam_id), get_family_name(fam_id), get_rang_family(fam_id,fam_rank_invite), pData[playerid_invite][pNickname], playerid_invite, 
		get_rang_family(fam_id, fam_rank), pData[playerid][pNickname], playerid);
	send_family_chat(fam_id, String256);    

 

	SendSucc(playerid_invite, "Поздравляем со вступлением в семью!");

    create_family_label_text(playerid_invite);

	offer_clear_accept(playerid);
	offer_clear_accept(playerid_invite);
	return true;
}

stock accept_invite_family_dialog(playerid, playerid_invite)
{
	if(pData[playerid_invite][pFamily] != -1)
		return SendErr(playerid, "Игрок уже состоит в семье!");

	new 
		fam_id = pData[playerid][pFamily],
		fam_rank = pData[playerid][pFamilyRank]-1;

	pData[playerid_invite][pFamily] = fam_id;
	pData[playerid_invite][pFamilyRank] = 1;

    UpdatePlayerData(playerid_invite, "pFamily", pData[playerid_invite][pFamily]);
    UpdatePlayerData(playerid_invite, "pFamilyRank", pData[playerid_invite][pFamilyRank]);

    new 
    	fam_rank_invite = pData[playerid_invite][pFamilyRank]-1;

	format(String256, sizeof(String256), "%s[%s] %s %s [%d] был приглашен в семью %s %s [%d]",  
		get_color_family(fam_id), get_family_name(fam_id), get_rang_family(fam_id,fam_rank_invite), pData[playerid_invite][pNickname], playerid_invite, 
		get_rang_family(fam_id, fam_rank), pData[playerid][pNickname], playerid);
	send_family_chat(fam_id, String256);    

	SendSucc(playerid_invite, "Поздравляем со вступлением в семью!");

	offer_clear_accept(playerid);
	offer_clear_accept(playerid_invite);

    create_family_label_text(playerid_invite);


	return true;
}

stock family_uninvite_player(playerid, playerid_to)
{
	new 
		fam_id = pData[playerid][pFamily],
		fam_rank_1 = pData[playerid][pFamilyRank]-1,
		fam_rank_2 = pData[playerid_to][pFamilyRank]-1;

	format(String256, sizeof(String256), "%s[%s] %s %s [%d] был исключен из семьи %s %s [%d]",  get_color_family(fam_id), get_family_name(fam_id), get_rang_family(fam_id, fam_rank_2), pData[playerid_to][pNickname], playerid_to, 
		get_rang_family(fam_id, fam_rank_1), pData[playerid][pNickname], playerid);
	send_family_chat(fam_id, String256);

	pData[playerid_to][pFamily] = -1;
	pData[playerid_to][pFamilyRank] = -1;

    UpdatePlayerData(playerid_to, "pFamily", pData[playerid_to][pFamily]);
    UpdatePlayerData(playerid_to, "pFamilyRank", pData[playerid_to][pFamilyRank]);

    clear_family_label_text(playerid);

    return true;	
}

stock dialog_all_family(playerid, dialogid, response, listitem, inputtext[])
{

	switch(dialogid)
	{
		case DIALOG_ACCEPT_FAMILY_PASS:
		{
			new 
				offerid = GetPVarIntNew(playerid, "recieve_show_family_pass")-1;

			if(!response)
			{
				DeletePVarNew(playerid, "recieve_show_family_pass");

				SendInf(playerid, "Вы отказались от просмотра семейного паспорта");

				if(GetPVarIntNew(offerid, "offer_show_family_pass")-1 == playerid)
				{
					DeletePVarNew(offerid, "offer_show_family_pass");
					format(String64, sizeof(String64), "%s отказался от просмотра семейного паспорта", pData[playerid][pNickname]);
					SendInf(offerid, String64);
				}
				return true;
			}

			if(GetPVarIntNew(offerid, "offer_show_family_pass") != playerid+1)
				return SendErr(playerid, "Предложение неактивно");

			DeletePVarNew(playerid, "recieve_show_family_pass");
			DeletePVarNew(offerid, "offer_show_family_pass");

			if(GetPlayerDistanceToPlayer(playerid, offerid) > 3.0 || GetPlayerVirtualWorld(playerid) != GetPlayerVirtualWorld(offerid))
				return SendErr(playerid, "Вы находитесь далеко друг от друга");	

			show_family_pass(offerid, playerid);
			return true;
		}
		case DIALOG_INVITE_FAMILY_ACCEPT:
		{
			if(!response)
			{
				DeletePVarNew(playerid, "id_family");
				DeletePVarNew(playerid, "id_invite_family");
				return true;
			}

			accept_invite_family_dialog(GetPVarIntNew(playerid, "id_invite_family")-1, playerid);

		}
		case DIALOG_FAM_MENU_PICKUP:
		{
			if(!response) 
				return true;

			switch(listitem)
			{
				case 0:	return dialog_create_family_1(playerid);
				case 1:	return check_all_family_server(playerid);
				case 2: return check_top_famiy_server(playerid);
				case 3: return check_top_war_family_server(playerid);
			}			
		}
		case DIALOG_CLOSE_FAMILY:
		{
			new 
				fam = pData[playerid][pFamily];

			if(!response) 
			{
				if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam))
					return family_panel_owner(playerid);	
				if(pData[playerid][pFamilyRank] != 7)
					return family_panel_player(playerid);			
			}
			if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam))
				return family_panel_owner(playerid);	
			if(pData[playerid][pFamilyRank] != 7)
				return family_panel_player(playerid);	

		}
		case DIALOG_FAMILY_OFFLINE:
		{
		    if(response) 
		    {
		    	part_family_offline[playerid] += 20;
		    }
		    else 
		    {
		        if(part_family_offline[playerid] >= 20) part_family_offline[playerid] -= 20;
		        else return true;
		    }

			format(String512, sizeof(String512), "SELECT * FROM `accounts` WHERE `pFamily` = '%d' LIMIT %i, 20", pData[playerid][pFamily]+1, part_family_offline[playerid]);
			new Result:family_offline_load = sql_queryEx(zConn, String512, QUERY_CACHED);

			if(sql_num_rows(family_offline_load) > 0)
			{
				new all_fam_offline = sql_num_rows(family_offline_load);

				new 
					name_fam_off[MAX_PLAYER_NAME],
					level_fam_off;

			 	for(new i; i < all_fam_offline; i++)
				{

					sql_get_field_assoc_ex(family_offline_load, i,"nickname", name_fam_off, MAX_PLAYER_NAME);
					level_fam_off  = sql_get_field_assoc_int_ex(family_offline_load, i, "level"); 

					format(String256, sizeof(String256), ""cBLUE"%i."cWH" %s - Уровень: "cBLUE"%d"cWH"\n", i+1, name_fam_off, level_fam_off);

				}
				SPD(playerid, DIALOG_FAMILY_OFFLINE, 0, !""cWH"Члены семьи оффлайн", String256, !"Далее", !"Назад");				
			}
			else
			{
				family_all_player(playerid);
				SendErr(playerid, "Больше в семье нет участников!");
			}
			sql_next_row(family_offline_load);

		}
		case DIALOG_CHANGE_FAMILE_MES_INPUT:
		{
			if(!response) 
			{
				DeletePVarNew(playerid, "get_change_fam_rank");
				return family_panel_owner(playerid);
			}

			new 
				fam = pData[playerid][pFamily];


			if(strlen(inputtext) < 5 || strlen(inputtext) > 24)
			{
			    SendErr(playerid,"Слишком короткое/длинное приветствие для семьи!");
				return family_change_message(playerid);
			}
			
			if(IsNumeric(inputtext) || check_no_valid_symbol_text(inputtext) || check_sql_injection_text(inputtext))
			{
				family_change_message(playerid);
				return SendErr(playerid,"Название содержит запрещенные символы!");
			}

			SendSucc(playerid, "Вы успешно обновили приветствие при входе для семьи!");
		    format(String144, sizeof(String144), "Новое приветствие - %s", inputtext);
		    SendInf(playerid, String144);			

		    format(String256, sizeof(String256), "UPDATE `family` SET \
			family_message = '%s'\
	    	WHERE family_id = '%d'",
	    	inputtext,
	    	fam);

	   		sql_queryEx(zConn, String256, QUERY_THREADED);

			return family_panel_owner(playerid);			
		}
		case DIALOG_CHANGE_FAMILE_RANK_INPUT:
		{

			if(!response) 
			{
				DeletePVarNew(playerid, "get_change_fam_rank");
				return family_change_name_rank(playerid);
			}

			new 
				id_fam_rank = GetPVarIntNew(playerid, "get_change_fam_rank");

			new 
				fam = pData[playerid][pFamily];


			if(strlen(inputtext) < 5 || strlen(inputtext) > 24)
			{
			    SendErr(playerid,"Слишком короткое/длинное название ранга для семьи!");
				return change_name_rank_family(playerid, id_fam_rank);
			}
			
			if(IsNumeric(inputtext) || check_no_valid_symbol_text(inputtext) || check_sql_injection_text(inputtext))
			{
				change_name_rank_family(playerid, id_fam_rank);
				return SendErr(playerid,"Название содержит запрещенные символы!");
			}

		    format(String256, sizeof(String256), "Вы успешно изменили наименование ранга в семье с %s на %s (Ранг: %d)", 
		    	get_rang_family(fam, id_fam_rank), inputtext, id_fam_rank+1);
		    SendSucc(playerid, String256);		

			format(String256, sizeof(String256), "UPDATE `family` SET \
			family_rank_%d = '%s'\
	    	WHERE family_id = '%d'",
	    	id_fam_rank+1,
	    	inputtext,
	    	fam);

	   		sql_queryEx(zConn, String256, QUERY_THREADED);	

			DeletePVarNew(playerid, "get_change_fam_rank");

			return family_panel_owner(playerid);

		}
		case DIALOG_CHANGE_RANK_FAM_P:
		{
			if(!response) 
			{
				DeletePVarNew(playerid, "family_giverank_id");
				return true;
			}
			switch(listitem)
			{
				case 0:	return give_player_rank_family(playerid, 0);
				case 1:	return give_player_rank_family(playerid, 1);
				case 2:	return give_player_rank_family(playerid, 2);
				case 3:	return give_player_rank_family(playerid, 3);
				case 4:	return give_player_rank_family(playerid, 4);
				case 5:	return give_player_rank_family(playerid, 5);
				case 6:	return give_player_rank_family(playerid, 6);
			}				

		}
		case DIALOG_CHANGE_FAM_RANK_INV:
		{
			if(!response) 
				return family_panel_owner(playerid);

			switch(listitem)
			{
				case 1:	return change_invite_rank_family(playerid, 0);
				case 2:	return change_invite_rank_family(playerid, 1);
				case 3:	return change_invite_rank_family(playerid, 2);
				case 4:	return change_invite_rank_family(playerid, 3);
				case 5:	return change_invite_rank_family(playerid, 4);
				case 6:	return change_invite_rank_family(playerid, 5);
				case 7:	return change_invite_rank_family(playerid, 6);
			}			
		}
		case DIALOG_CHANGE_FAMILY_GIVE_RANK:
		{
			if(!response) 
				return family_panel_owner(playerid);

			switch(listitem)
			{
				case 1:	return change_give_rank_family(playerid, 0);
				case 2:	return change_give_rank_family(playerid, 1);
				case 3:	return change_give_rank_family(playerid, 2);
				case 4:	return change_give_rank_family(playerid, 3);
				case 5:	return change_give_rank_family(playerid, 4);
				case 6:	return change_give_rank_family(playerid, 5);
				case 7:	return change_give_rank_family(playerid, 6);
			}					
		}
		case DIALOG_CHANGE_FAM_RANK_UNINV:
		{
			if(!response) 
				return family_panel_owner(playerid);

			switch(listitem)
			{
				case 1:	return change_uninvite_rank_family(playerid, 0);
				case 2:	return change_uninvite_rank_family(playerid, 1);
				case 3:	return change_uninvite_rank_family(playerid, 2);
				case 4:	return change_uninvite_rank_family(playerid, 3);
				case 5:	return change_uninvite_rank_family(playerid, 4);
				case 6:	return change_uninvite_rank_family(playerid, 5);
				case 7:	return change_uninvite_rank_family(playerid, 6);
			}				
		}
		case DIALOG_CHANGE_FAMILY_NAME:
		{
			if(!response)
				return family_panel_owner(playerid);


			if(pData[playerid][pDonate] < PRICE_CHANGE_FAMILY_NAME)
				return SendErr(playerid, "У вас недостаточно рублей на донат счёте");

			if(strlen(inputtext) < 5 || strlen(inputtext) > 20)
			{
			    SendErr(playerid,"Слишком короткое/длинное название для семьи!");
				return family_change_name(playerid);
			}
			
			if(IsNumeric(inputtext) || check_no_valid_symbol_text(inputtext) || check_sql_injection_text(inputtext))
			{
				family_change_name(playerid);
				return SendErr(playerid,"Название содержит запрещенные символы!");
			}

			new query[128];
			format(query, sizeof(query), "SELECT `family_name` FROM `family` WHERE `family_name` = '%s'", inputtext);
			new Result:r = sql_queryEx(zConn, query);

			if(sql_num_rows(r)) 
			{
				SendErr(playerid, "Такое наименование семьи уже используется!");
				sql_free_result(r);
				return family_change_name(playerid);
			}
			sql_free_result(r);	


			new 
				fam_id = pData[playerid][pFamily];

			format(String144, sizeof(String144), "%s[%s %s] Название семьи было изменено на %s",  
				get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), inputtext);
			send_family_chat(fam_id, String144);

			format(String256, sizeof(String256), "UPDATE `family` SET family_name = '%s' WHERE family_id = '%i'", inputtext, fam_id);
			sql_queryEx(zConn, String256, QUERY_THREADED);

			foreach(new i: logged_players)
			{
				if(!IsPlayerConnected(i)) continue;
				if(pData[i][pFamily] != fam_id) continue;

				update_family_label_text(i);
			}

			pData[playerid][pDonate] -= PRICE_CHANGE_FAMILY_NAME;
			UpdatePlayerData(playerid, "donate", pData[playerid][pDonate]);
			return true;
		}
		case DIALOG_CHANGE_FAMILY_NAME_RANK:
		{

			if(!response) 
				return family_panel_owner(playerid);

			switch(listitem)
			{
				case 0:	return change_name_rank_family(playerid, 0);
				case 1:	return change_name_rank_family(playerid, 1);
				case 2:	return change_name_rank_family(playerid, 2);
				case 3:	return change_name_rank_family(playerid, 3);
				case 4:	return change_name_rank_family(playerid, 4);
				case 5:	return change_name_rank_family(playerid, 5);
				case 6:	return change_name_rank_family(playerid, 6);
			}
		}
		case DIALOG_CHANGE_FAMILY_OTHER:
		{
			if(!response) 
				return true;

			switch(listitem)
			{
				case 0:	return family_info_show(playerid);
				case 1: return family_panel_warehouse(playerid);
				case 2: return show_family_cars(playerid);
				case 3:	return family_all_player(playerid);
				case 4:	return family_all_player_online(playerid);
				case 5: return family_panel_player(playerid);
				case 6: return family_player_leave_prew(playerid);
			}				
		}
		case DIALOG_LEAVE_FAMILY_FINAL:
		{
			if(!response) 
				return family_player_leave_prew(playerid);

			family_player_leave_final(playerid);
			
		}		
		case DIALOG_CHANGE_FAMILY_OWNER:
		{
			if(!response) 
				return true;

			switch(listitem)
			{  
				case 0:	return family_info_show(playerid);
				case 1: return family_panel_owner(playerid);
				case 2: return family_install_house(playerid);
				case 3: return family_upgrade_main(playerid);
				case 4: return family_change_name(playerid);
				case 5: return family_change_name_rank(playerid);
				case 6:	return family_change_message(playerid);
				case 7: return change_family_select_color(playerid);
				case 8:	return family_change_rank_invite(playerid);
				case 9:	return family_change_rank_uninvite(playerid);
				case 10: return family_change_rank_giverank(playerid);
				case 11: return family_panel_owner(playerid);
				case 12: return family_panel_warehouse(playerid);
				case 13: return show_family_cars(playerid);
				case 14: return family_all_player(playerid);
				case 15: return family_all_player_online(playerid);
			}			
		}
		case DIALOG_CREATE_FAMILY_START:
		{
			if(!response) 
				return SendInf(playerid, "Видимо в следующий раз! Семью Вы можете создать в любое время!");

			if(GetPlayerMoneyEx(playerid) < PRICE_CREATE_FAMILY)
			{
				show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
				return SendErr(playerid, "У вас недостаточно денежных средств для создания семьи!");
			}

			return create_family_select_name(playerid);
		}
		case DIALOG_CREATE_FAMILY_NAME:
		{
			if(!response) 
				return dialog_create_family_1(playerid);


			if(GetPlayerMoneyEx(playerid) < PRICE_CREATE_FAMILY)
			{
				show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
				return SendErr(playerid, "У вас недостаточно денежных средств для создания семьи!");
			}

			if(strlen(inputtext) < 5 || strlen(inputtext) > 20)
			{
			    SendErr(playerid,"Слишком короткое/длинное название для семьи!");
				return create_family_select_name(playerid);
			}
			
			if(IsNumeric(inputtext) || check_no_valid_symbol_text(inputtext) || check_sql_injection_text(inputtext))
			{
				create_family_select_name(playerid);
				return SendErr(playerid,"Название содержит запрещенные символы!");
			}

			format(family_create_name[playerid], 20, inputtext);

			return create_family_select_color(playerid);			

		}
		case DIALOG_CREATE_FAMILY_COLOR:
		{
			if(!response) 
				return create_family_select_name(playerid);

			if(GetPlayerMoneyEx(playerid) < PRICE_CREATE_FAMILY)
			{
				show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
				return SendErr(playerid, "У вас недостаточно денежных средств для создания семьи!");
			}

			switch(listitem)
			{
				case 0:	return select_color_family_final(playerid, 1);
				case 1:	return select_color_family_final(playerid, 2);
				case 2:	return select_color_family_final(playerid, 3);
				case 3:	return select_color_family_final(playerid, 4);
				case 4:	return select_color_family_final(playerid, 5);
				case 5:	return select_color_family_final(playerid, 6);
				case 6:	return select_color_family_final(playerid, 7);
				case 7:	return select_color_family_final(playerid, 8);
				case 8:	return select_color_family_final(playerid, 9);
				case 9:	return select_color_family_final(playerid, 10);
				case 10: return select_color_family_final(playerid, 11);
				case 11: return select_color_family_final(playerid, 12);
				case 12: return select_color_family_final(playerid, 13);
				case 13: return select_color_family_final(playerid, 14);
				case 14: return select_color_family_final(playerid, 15);
				case 15: return select_color_family_final(playerid, 16);
				case 16: return select_color_family_final(playerid, 17);
				case 17: return select_color_family_final(playerid, 18);
				case 18: return select_color_family_final(playerid, 19);
				case 19: return select_color_family_final(playerid, 20);
				case 20: return select_color_family_final(playerid, 21);
			}

		}
		case DIALOG_FAMILY_CHANGE_COLOR:
		{
			if(!response) 
				return true;

			switch(listitem)
			{
				case 0:	return change_color_family_final(playerid, 1);
				case 1:	return change_color_family_final(playerid, 2);
				case 2:	return change_color_family_final(playerid, 3);
				case 3:	return change_color_family_final(playerid, 4);
				case 4:	return change_color_family_final(playerid, 5);
				case 5:	return change_color_family_final(playerid, 6);
				case 6:	return change_color_family_final(playerid, 7);
				case 7:	return change_color_family_final(playerid, 8);
				case 8:	return change_color_family_final(playerid, 9);
				case 9:	return change_color_family_final(playerid, 10);
				case 10: return change_color_family_final(playerid, 11);
				case 11: return change_color_family_final(playerid, 12);
				case 12: return change_color_family_final(playerid, 13);
				case 13: return change_color_family_final(playerid, 14);
				case 14: return change_color_family_final(playerid, 15);
				case 15: return change_color_family_final(playerid, 16);
				case 16: return change_color_family_final(playerid, 17);
				case 17: return change_color_family_final(playerid, 18);
				case 18: return change_color_family_final(playerid, 19);
				case 19: return change_color_family_final(playerid, 20);
				case 20: return change_color_family_final(playerid, 21);
			}
			return family_panel_owner(playerid);		
		}
		case DIALOG_FAMILY_WAR_INFO:
		{
			if(!response)
				return true;

			format(String512, sizeof(String512), "SELECT * FROM family WHERE family_name  = '%s' LIMIT 1", inputtext[3]);
			new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

			if(!sql_num_rows(result))
				return SendErr(playerid, "Произошла ошибка #2412-2 (family war)");
			new 
				fam_id = sql_get_field_assoc_int_ex(result, 0, "family_id");
			sql_next_row(result);

			if(pData[playerid][pFamily] == fam_id)
				return SendErr(playerid, "Вы не можете начинать войну со своей же семьей");

			if(fam_members_online(fam_id) < 3)
				return SendErr(playerid, "В семье недостаточный онлайн");

			if(family_war[wStatus])
				return SendErr(playerid, "Сейчас уже идёт война семей");

			SetPVarIntNew(playerid, "family_war", fam_id);

			format(String512, sizeof(String512), "\
			"cWH"Вы действительно хотите начать войну с семьей "cBLUE"%s\n\
			"cWH"Онлайн семьи: "cBLUE"%i",
			inputtext[3],
			fam_members_online(fam_id));
			SPD(playerid, DIALOG_FAMILY_WAR_ACCEPT, DIALOG_STYLE_MSGBOX, !""cBLUE"Информация о захвате", String512, !"Далее", !"Отмена");
			return true;
		}
		case DIALOG_FAMILY_WAR_ACCEPT:
		{
			if(!response)
			{
				DeletePVarNew(playerid, "family_war");
				return true;
			}

			new
				select_zone[150];

			for(new i; i < 3; i++) 
				format(select_zone, sizeof(select_zone), "%s"cBLUE"- "cWH"%s\n", select_zone, Zone_Name[i]);

			SPD(playerid, DIALOG_FAMILY_WAR_SELECT_MAP, DIALOG_STYLE_LIST, !""cBLUE"Выберите место проведения стрелы:", select_zone, !"Выбрать", !"Отмена");

			return true;
		}
		case DIALOG_FAMILY_WAR_SELECT_MAP:
		{
			if(!response)
			{
				DeletePVarNew(playerid, "family_war");
				return true;
			}

			new 
				fam_id = GetPVarIntNew(playerid, "family_war"),
				fam = pData[playerid][pFamily];

			if(pData[playerid][pFamily] == fam_id)
				return SendErr(playerid, "Вы не можете начинать войну со своей же семьей");

			if(fam_members_online(fam_id) < 3)
				return SendErr(playerid, "В семье недостаточный онлайн");

			if(family_war[wStatus] || mafia_war[wStatus])
				return SendErr(playerid, "Сейчас уже идёт война семей");

			family_war[wZone] = GangZoneCreate(gWar_Zone[listitem][0], gWar_Zone[listitem][1], gWar_Zone[listitem][2], gWar_Zone[listitem][3]);
			family_war[wArea] = CreateDynamicRectangle(gWar_Zone[listitem][0], gWar_Zone[listitem][1], gWar_Zone[listitem][2], gWar_Zone[listitem][3]);

			foreach(new i : Player)
			{
				if(pData[i][pFamily])
				{
					GangZoneShowForPlayer(i, family_war[wZone], 0xFF0000AA);

					for(new tds; tds < 8; tds++)
						TextDrawShowForPlayer(i, tdBizWar[tds]);	
				}
			}
			format(String144, sizeof(String144), "%s[%s %s] Вашей семье забили войну! Место проведения: "cBLUE"%s"
				,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), Zone_Name[listitem]);
			send_family_chat(fam_id, String144);
			format(String144, sizeof(String144), "%s[%s %s] У Вас есть 10 минут чтобы прибыть на место проведения стрелы"
				,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), Zone_Name[listitem]);
			send_family_chat(fam_id, String144);

			format(String144, sizeof(String144), "%s[%s %s] Вы забили войну одной из семей! Место проведения: "cBLUE"%s"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), Zone_Name[listitem]);
			send_family_chat(fam, String144);
			format(String144, sizeof(String144), "%s[%s %s] У Вас есть 10 минут чтобы прибыть на место проведения стрелы"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), Zone_Name[listitem]);
			send_family_chat(fam, String144);

			family_war[wStatus] = 1;
			family_war[wDefense] = fam_id;
			family_war[wAttack] = pData[playerid][pFamily];
			family_war[wDScore] = 0;
			family_war[wAScore] = 0;
			family_war[wTimer] = 600;

			TextDrawSetString(tdBizWar[1], "0");
            TextDrawSetString(tdBizWar[2], "0");

            new 
            	str_mafia[40];

            format(str_mafia, sizeof (str_mafia), "%s", get_family_name(family_war[wDefense]));
            TextDrawSetString(tdBizWar[4], str_mafia);

            format(str_mafia, sizeof (str_mafia), "%s", get_family_name(family_war[wAttack]));
            TextDrawSetString(tdBizWar[5], str_mafia);
			return true;

		}
		case DIALOG_FAMILY_INFO:
		{
			if(!response)
				return info_family_pickup(playerid);

			new 
				fam_name[32];

			format(fam_name, sizeof(fam_name), "%s", inputtext[2]);

			format(String512, sizeof(String512), "SELECT * FROM family WHERE family_name  = '%s' LIMIT 1", fam_name);
			new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

			if(!sql_num_rows(result))
				return SendErr(playerid, "Произошла ошибка #2412-1 (family)");	

			new 
				fam_id,
				osnov_id,
				zam_id,
				fam_win,
				fam_lose,
				fam_date[20],
				name_osnov[MAX_PLAYER_NAME],
				name_zam[MAX_PLAYER_NAME];

			fam_id = sql_get_field_assoc_int_ex(result, 0, "family_id");
			osnov_id = sql_get_field_assoc_int_ex(result, 0, "family_owner_id");
			zam_id = sql_get_field_assoc_int_ex(result, 0, "family_c_owner_id");
			fam_win = sql_get_field_assoc_int_ex(result, 0, "family_win");
			fam_lose = sql_get_field_assoc_int_ex(result, 0, "family_lose");
        	sql_get_field_assoc_ex(result, 0, "family_create_date", fam_date);

			sql_next_row(result);	

			GetPlayerNameByID(osnov_id, name_osnov);
			GetPlayerNameByID(zam_id, name_zam);

			format(String512, sizeof(String512), "\
			"cWH"Семья: 		\t%s%s\n\
			"cWH"Тип:			\t"cBLUE"%s\n\n\
			"cWH"Побед:			\t"cBLUE"%i\n\
			"cWH"Поражений:		\t"cBLUE"%i\n\n\
			"cWH"Создатель: 		\t"cBLUE"%s\n\
			"cWH"Заместитель: 		\t"cBLUE"%s\n\
			"cWH"Дата основания: 	\t"cBLUE"%s\n\n\
			"cWH"Участников: 		\t"cBLUE"%i\n\
			"cWH"В сети:			\t"cBLUE"%i",
			get_color_family(fam_id),
			fam_name,
			get_family_tag_type(fam_id),
			fam_win,
			fam_lose,
			name_osnov,
			name_zam,
			fam_date,
			fam_members(fam_id),
			fam_members_online(fam_id));
			SPD(playerid, 0, DIALOG_STYLE_MSGBOX, !""cBLUE"Информация о семье", String512, !"Закрыть", "");
			return true;
		}
		case DIALOG_UPGRADE_FAMILY:
		{
			if(!response)
				return family_panel_owner(playerid);

			new 
				fam_id = pData[playerid][pFamily];

			switch(listitem)
			{
				case 0:
				{
					if(get_family_type(fam_id) >= 1)
					{
						SendErr(playerid, "У Вас уже куплено данное улучшение");
						return family_upgrade_main(playerid);
					}

					if(get_family_level(fam_id) < 5)
					{
						SendErr(playerid, "У семьи недостаточный уровень для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					if(GetPlayerMoneyEx(playerid) < PRICE_FAMILY_UPGRADE_CORP)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						SendErr(playerid, "У Вас недостаточно денег для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					format(String144, sizeof(String144), "%s[%s %s] Семья была улучшена до типа 'Корпорация'"
						,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id));
					send_family_chat(fam_id, String144);

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_type = '1'\
				    	WHERE family_id = '%i'",
				    	fam_id);

					sql_queryEx(zConn, String256, QUERY_THREADED);


					foreach(new i: logged_players)
					{
						if(!IsPlayerConnected(i)) continue;
						if(pData[i][pFamily] != fam_id) continue;

						update_family_label_text(i);
					}

					give_money(playerid, -PRICE_FAMILY_UPGRADE_CORP, "Улучшение семьи до корпорации");
				}
				case 1:
				{
					if(get_family_type(fam_id) >= 2)
					{
						SendErr(playerid, "У Вас уже куплено данное улучшение");
						return family_upgrade_main(playerid);
					}

					if(get_family_level(fam_id) < 10)
					{
						SendErr(playerid, "У семьи недостаточный уровень для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					if(GetPlayerMoneyEx(playerid) < PRICE_FAMILY_UPGRADE_SYNDICATE)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						SendErr(playerid, "У Вас недостаточно денег для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					format(String144, sizeof(String144), "%s[%s %s] Семья была улучшена  до типа 'Синдикат'"
						,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id));
					send_family_chat(fam_id, String144);

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_type = '2'\
				    	WHERE family_id = '%i'",
				    	fam_id);

					sql_queryEx(zConn, String256, QUERY_THREADED);


					foreach(new i: logged_players)
					{
						if(!IsPlayerConnected(i)) continue;
						if(pData[i][pFamily] != fam_id) continue;

						update_family_label_text(i);
					}

					give_money(playerid, -PRICE_FAMILY_UPGRADE_SYNDICATE, "Улучшение семьи до синдиката");
				}
				case 2:
				{
					if(get_family_type(fam_id) >= 3)
					{
						SendErr(playerid, "У Вас уже куплено данное улучшение");
						return family_upgrade_main(playerid);
					}

					if(get_family_level(fam_id) < 15)
					{
						SendErr(playerid, "У семьи недостаточный уровень для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					if(GetPlayerMoneyEx(playerid) < PRICE_FAMILY_UPGRADE_BRIGADE)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						SendErr(playerid, "У Вас недостаточно денег для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					format(String144, sizeof(String144), "%s[%s %s] Семья была улучшена до типа 'Бригада'"
						,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id));
					send_family_chat(fam_id, String144);

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_type = '3'\
				    	WHERE family_id = '%i'",
				    	fam_id);

					sql_queryEx(zConn, String256, QUERY_THREADED);


					foreach(new i: logged_players)
					{
						if(!IsPlayerConnected(i)) continue;
						if(pData[i][pFamily] != fam_id) continue;

						update_family_label_text(i);
					}

					give_money(playerid, -PRICE_FAMILY_UPGRADE_BRIGADE, "Улучшение семьи до бригады");
				}
				case 3:
				{
					if(get_family_capacity(fam_id) == 1)
					{
						SendErr(playerid, "У Вас уже куплено данное улучшение");
						return family_upgrade_main(playerid);
					}

					if(GetPlayerMoneyEx(playerid) < PRICE_FAMILY_UPGRADE_CAPACITY)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						SendErr(playerid, "У Вас недостаточно денег для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					format(String144, sizeof(String144), "%s[%s %s] Семья была расширена до 50 человек"
						,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id));
					send_family_chat(fam_id, String144);

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_capacity = '1'\
				    	WHERE family_id = '%i'",
				    	fam_id);

					sql_queryEx(zConn, String256, QUERY_THREADED);

					give_money(playerid, -PRICE_FAMILY_UPGRADE_CAPACITY, "Улучшение семьи до 50 человек");
				}
				case 4:
				{
					if(get_family_veh_capacity(fam_id) == 1)
					{
						SendErr(playerid, "У Вас уже куплено данное улучшение");
						return family_upgrade_main(playerid);
					}

					if(GetPlayerMoneyEx(playerid) < PRICE_FAMILY_UPGRADE_VEHICLE)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						SendErr(playerid, "У Вас недостаточно денег для покупки улучшения");
						return family_upgrade_main(playerid);
					}

					format(String144, sizeof(String144), "%s[%s %s] Автопарк семьи был расширен до 8 транспортных средств"
						,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id));
					send_family_chat(fam_id, String144);

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_veh_capacity = '1'\
				    	WHERE family_id = '%i'",
				    	fam_id);

					sql_queryEx(zConn, String256, QUERY_THREADED);

					give_money(playerid, -PRICE_FAMILY_UPGRADE_VEHICLE, "Расширение автопарка семьи до 8 авто");
				}
				case 5:
				{
					format(String2048, sizeof(String2048), "\n\
						"cBLUE"[Тип семьи 'Корпорация']\n\
						"cBLUE"- "cWH"Возможность покупки семейного транспорта из автосалона Среднего класса\n\
						"cBLUE"- "cWH"Доступен общак семьи\n\
						"cWH"Стоимость улучшения: "cGREY"5 уровень семьи, %i рублей\n\n\
						"cBLUE"[Тип семьи 'Синдикат']\n\
						"cBLUE"- "cWH"Все улучшения типа 'Корпорация'\n\
						"cBLUE"- "cWH"Возможность покупки семейного транспорта из автосалона Элитного класса\n\
						"cBLUE"- "cWH"Возможность участвовать в семейных стрелах\n\
						"cBLUE"- "cWH"Расширение семейного общака до 20 тысяч\n\
						"cWH"Стоимость улучшения: "cGREY"10 уровень семьи, %i рублей\n\n\
						"cBLUE"[Тип семьи 'Бригада']\n\
						"cBLUE"- "cWH"Все улучшения типа 'Синдикат'\n\
						"cBLUE"- "cWH"Семейный опыт в payday начисляется в 2 раза больше\n\
						"cWH"Стоимость улучшения: "cGREY"15 уровень семьи, %i рублей\n\n\
						"cBLUE"[Расширение вместимости]\n\
						"cBLUE"- "cWH"Максимальная численность семьи возрастает с 25 до 50 человек\n\
						"cWH"Стоимость улучшения: "cGREY"%i рублей\n\n\
						"cBLUE"[Расширение семейного автопарка]\n\
						"cBLUE"- "cWH"Кол-во слотов под семейный транспот увеличивается до 8 автомобилей\n\
						"cWH"Стоимость улучшения: "cGREY"%i рублей\n", 
						PRICE_FAMILY_UPGRADE_CORP, PRICE_FAMILY_UPGRADE_SYNDICATE, PRICE_FAMILY_UPGRADE_BRIGADE, PRICE_FAMILY_UPGRADE_CAPACITY, PRICE_FAMILY_UPGRADE_VEHICLE);
					SPD(playerid, 0, DIALOG_STYLE_MSGBOX, !""cBLUE"Улучшения семьи", String2048, !"Закрыть", "");
				}
			}
			return true;
		}
		case DIALOG_FAMILY_VEHICLES_LIST:
		{
			if(!response)
				return true;

			new
				car_num = listitem;


			new 
				fam_id = pData[playerid][pFamily];

			format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `family_id` = '%i'", fam_id);
			new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

			new all_veh = sql_num_rows(result);

			if(!all_veh)
				return SendErr(playerid, "Транспорт не найден");

			new 	
				sql_id = sql_get_field_assoc_int_ex(result, car_num, "id");


			if(get_fam_veh_status(sql_id) == 1)
			{
				return show_family_vehicle_menu(playerid, sql_id);
			}

			if(!get_player_fam_owner(playerid, fam_id) && !get_player_fam_zam(playerid, fam_id))
						return SendErr(playerid, "Загрузка транспорта доступна основателю и его заместителю");

			SendSucc(playerid, "Вы загрузили семейное транспортное средство");

			spawn_family_vehicle(sql_id);
			sql_free_result(result);
		}
		case DIALOG_FAMILY_VEHICLE:
		{
			if(!response)
				return show_family_cars(playerid);

			new
				fam = pData[playerid][pFamily],
				sql_id = GetPVarIntNew(playerid, "family_veh_sql");

			switch(listitem)
			{
				case 0:
				{
					return get_family_vehicle_pos(playerid, sql_id);
				}
				case 1:
				{
					if(!get_player_fam_owner(playerid, fam) && !get_player_fam_zam(playerid, fam))
						return SendErr(playerid, "Команда доступна основателю и его заместителю");

					if(GetPlayerMoneyEx(playerid) < 1000)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						return SendErr(playerid, "У Вас недостаточно денег");
					}

					destroy_family_vehicle(sql_id);
					spawn_family_vehicle(sql_id);

					give_money(playerid, -1000, "Спавн семейного транспорта");

					return SendSucc(playerid, "Вы зареспавнили семейное транспортное средство");
				}
				case 2:
				{
					if(!get_player_fam_owner(playerid, fam) && !get_player_fam_zam(playerid, fam))
						return SendErr(playerid, "Команда доступна основателю и его заместителю");

					if(GetPlayerMoneyEx(playerid) < 1000)
					{
						show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
						return SendErr(playerid, "У Вас недостаточно денег");
					}

					destroy_family_vehicle(sql_id);

					give_money(playerid, -1000, "Выгрузка семейного транспорта");

					return SendSucc(playerid, "Вы выгрузили семейное транспортное средство");
				}
			}
			return true;
		}
		case DIALOG_FAMILY_WAREHOUSE_LIST:
		{
			if(!response)
				return true;

			new 
				fam = pData[playerid][pFamily];

			switch(listitem)
			{
				case 0: return show_family_put_money(playerid);
				case 1: return show_family_put_drugs(playerid);
				case 2: return show_family_put_hdrugs(playerid);
				case 3: return show_family_take_money(playerid);
				case 4: return show_family_take_drugs(playerid);
				case 5: return show_family_take_hdrugs(playerid);
				case 6:
				{
					if(!get_player_fam_owner(playerid, fam) && !get_player_fam_zam(playerid, fam))
						return SendErr(playerid, "Команда доступна основателю и его заместителю");

					new 
						fam_status;

					if(get_family_wh_status(fam) == 1)
					{
						fam_status = 0;
					}
					else
					{
						fam_status = 1;
					}

					format(String256, sizeof(String256), "UPDATE `family` SET \
				    	family_wh_status = '%i' WHERE family_id  = '%i'",
				    	fam_status,
				    	fam);

					sql_queryEx(zConn, String256, QUERY_THREADED);

					format(String144, sizeof(String144), "%s[%s %s] %s %s %sобщак семьи"
						,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], fam_status == 1 ? (""cLRED"закрыл") : (""cGR"открыл"), get_color_family(fam));
					send_family_chat(fam, String144);
				}
			}
			return true;
		}
		case DIALOG_FAMILY_PUT_MONEY:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_put_money(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	if(GetPlayerMoneyEx(playerid) < strval(inputtext))
		   	{
		   		show_notify_gui(playerid, TEXTDRAW_SHOW, NOTIFY_GUI_256_RIGHT, "brilliantother:notify_player_21", 3000);
		   		show_family_put_money(playerid);
		   		SendErr(playerid, "У Вас недостаточно денег");
		   		return true;     
		   	}

		   	give_money(playerid, -strval(inputtext), "Пополнение общака семьи");

		   	new 
		   		fam = pData[playerid][pFamily];

		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_money =  family_money + %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s положил в общак семьи "cGR"%i рублей"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
		case DIALOG_FAMILY_PUT_DRUGS:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_put_drugs(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	if(pData[playerid][pDrugs] < strval(inputtext))
		   	{
		   		show_family_put_drugs(playerid);
		   		SendErr(playerid, "У Вас недостаточно наркотиков");
		   		return true;     
		   	}

		   	new 
		   		fam = pData[playerid][pFamily];

		   	if(get_family_drugs(fam) + strval(inputtext) > MAX_FAMILY_WAREHOUSE)
		   	{
		   		show_family_put_drugs(playerid);
		   		SendErr(playerid, "В общаке недостаточно места под наркотики");
		   		return true;  
		   	}

		   	pData[playerid][pDrugs] -= strval(inputtext);
		   	UpdatePlayerData(playerid, "drugs", pData[playerid][pDrugs]);


		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_drugs =  family_drugs + %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s положил в общак семьи "cGR"%i гр. наркотиков"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
		case DIALOG_FAMILY_PUT_HDRUGS:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_put_hdrugs(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	if(pData[playerid][pHDrugs] < strval(inputtext))
		   	{
		   		show_family_put_hdrugs(playerid);
		   		SendErr(playerid, "У Вас недостаточно наркотиков");
		   		return true;     
		   	}

		   	new 
		   		fam = pData[playerid][pFamily];

		   	if(get_family_hdrugs(fam) + strval(inputtext) > MAX_FAMILY_WAREHOUSE)
		   	{
		   		show_family_put_hdrugs(playerid);
		   		SendErr(playerid, "В общаке недостаточно места под наркотики");
		   		return true;  
		   	}

		   	pData[playerid][pHDrugs] -= strval(inputtext);
		   	UpdatePlayerData(playerid, "hdrugs", pData[playerid][pHDrugs]);


		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_hdrugs =  family_hdrugs + %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s положил в общак семьи "cGR"%i гр. тяжёлых наркотиков"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
		case DIALOG_FAMILY_TAKE_MONEY:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_take_money(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	new 
		   		fam = pData[playerid][pFamily];

		   	if(get_family_money(fam) < strval(inputtext))
		   	{
		   		show_family_take_money(playerid);
		   		SendErr(playerid, "В общаке недостаточно денег");
		   		return true;     
		   	}

		   	give_money(playerid, strval(inputtext), "Снятие денег с общака семьи");


		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_money =  family_money - %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s взял с общака семьи "cGR"%i рублей"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
		case DIALOG_FAMILY_TAKE_DRUGS:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_take_drugs(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	if(pData[playerid][pDrugs] + strval(inputtext) > 1000)
		   	{
		   		show_family_take_drugs(playerid);
		   		SendErr(playerid, "Вы не можете взять столько наркотиков");
		   		return true;     
		   	}

		   	new 
		   		fam = pData[playerid][pFamily];

		   	if(get_family_wh_status(fam) == 1)
				return SendErr(playerid, "Общак закрыт.");

		   	if(get_family_drugs(fam) < strval(inputtext))
		   	{
		   		show_family_take_drugs(playerid);
		   		SendErr(playerid, "В общаке недостаточно наркотиков");
		   		return true;  
		   	}

		   	pData[playerid][pDrugs] += strval(inputtext);
		   	UpdatePlayerData(playerid, "drugs", pData[playerid][pDrugs]);


		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_drugs =  family_drugs - %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s взял с общака семьи "cGR"%i гр. наркотиков"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
		case DIALOG_FAMILY_TAKE_HDRUGS:
		{
			if(!response)
				return family_panel_warehouse(playerid);

			if(!strlen(inputtext) || !IsNumeric(inputtext) || strval(inputtext) < 0)
			{
		   		show_family_take_hdrugs(playerid);
		   		SendErr(playerid, "Неверное значение");
		   		return true;     
		   	}	

		   	if(pData[playerid][pHDrugs] + strval(inputtext) > 1000)
		   	{
		   		show_family_take_hdrugs(playerid);
		   		SendErr(playerid, "Вы не можете взять столько наркотиков");
		   		return true;     
		   	}

		   	new 
		   		fam = pData[playerid][pFamily];

		   	if(get_family_wh_status(fam) == 1)
				return SendErr(playerid, "Общак закрыт.");

		   	if(get_family_hdrugs(fam) < strval(inputtext))
		   	{
		   		show_family_take_hdrugs(playerid);
		   		SendErr(playerid, "В общаке недостаточно наркотиков");
		   		return true;  
		   	}

		   	pData[playerid][pHDrugs] += strval(inputtext);
		   	UpdatePlayerData(playerid, "drugs", pData[playerid][pHDrugs]);


		   	format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_hdrugs =  family_hdrugs - %i WHERE family_id  = '%i'",
		    	strval(inputtext),
		    	fam);

			sql_queryEx(zConn, String256, QUERY_THREADED);


			format(String144, sizeof(String144), "%s[%s %s] %s взял с общака семьи "cGR"%i гр. тяжёлых наркотиков"
				,  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), pData[playerid][pNickname], strval(inputtext));
			send_family_chat(fam, String144);

			return true;
		}
	}
	return true;
}

stock show_family_put_money(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите положить в общак семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i рублей", get_family_money(fam));

	SPD(playerid, DIALOG_FAMILY_PUT_MONEY, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}

stock show_family_put_drugs(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите положить в общак семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i гр. наркотиков", get_family_drugs(fam));

	SPD(playerid, DIALOG_FAMILY_PUT_DRUGS, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}

stock show_family_take_drugs(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите взять с общака семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i гр. наркотиков", get_family_drugs(fam));

	SPD(playerid, DIALOG_FAMILY_TAKE_DRUGS, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}

stock show_family_take_hdrugs(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите взять с общака семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i гр.  тяжёлых наркотиков", get_family_hdrugs(fam));

	SPD(playerid, DIALOG_FAMILY_TAKE_HDRUGS, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}


stock show_family_put_hdrugs(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите положить в общак семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i гр. тяжёлых наркотиков", get_family_hdrugs(fam));

	SPD(playerid, DIALOG_FAMILY_PUT_HDRUGS, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}

stock show_family_take_money(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	if(!get_player_fam_owner(playerid, fam))
		return SendErr(playerid, "Снять деньги может только основатель семьи");

	format(String256, sizeof(String256),"\n\
		"cWH"Введите сумму, которую хотите взять с общака семьи\n\
		"cWH"Сейчас в общаке: "cGR"%i рублей", get_family_money(fam));

	SPD(playerid, DIALOG_FAMILY_TAKE_MONEY, DIALOG_STYLE_INPUT, !""cBLUE"Общак семьи", String256, !"Далее", !"Назад");

	return true;
}

callback:: destroy_family_vehicle(sql_id)
{
	format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `id` = '%i'", sql_id);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_veh = sql_num_rows(result);

	if(!all_veh)
		return true;

	new 
		fam = sql_get_field_assoc_int_ex(result, 0, "family_id");	

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(family_vehicle_sql[fam][i] == sql_id)
		{
			DestroyVehicle(family_vehicle[fam][i]);

			family_vehicle_sql[fam][i] = 0;
			family_vehicle[fam][i] = 0;
			break;
		}
	}
	return true;
}

callback:: destroy_family_veh(vehicleid)
{	
	if(vehicleid == 0 || vehicleid == INVALID_VEHICLE_ID)
		return true;


	new 
		fam_sql = vehicle[vehicleid][cOwnTo];


	format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `id` = '%i'", fam_sql);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_veh = sql_num_rows(result);

	if(!all_veh)
		return true;

	new 
		fam = sql_get_field_assoc_int_ex(result, 0, "family_id");

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(family_vehicle_sql[fam][i] == vehicle[vehicleid][cOwnTo])
		{
		
			family_vehicle_sql[fam][i] = 0;
			family_vehicle[fam][i] = 0;

			DestroyVehicle(family_vehicle[fam][i]);

			break;
		}
	}
	return true;
}
callback:: update_family_war_time() // Секундный таймер
{
	TextDrawSetString(tdBizWar[2], Converts(family_war[wTimer]));

	if(family_war[wTimer] > 0 && family_war[wStatus] == 1)
    {
        family_war[wTimer]--;
    }
    if(family_war[wTimer] == 0 && family_war[wStatus] == 1)
    {

        format(String144, sizeof(String144), "%s[%s %s] Стрела началась!"
			,  get_color_family(family_war[wDefense]), get_family_tag_type(family_war[wDefense]), get_family_name(family_war[wDefense]));
		send_family_chat(family_war[wDefense], String144);

		format(String144, sizeof(String144), "%s[%s %s] Стрела началась!"
			,  get_color_family(family_war[wAttack]), get_family_tag_type(family_war[wAttack]), get_family_name(family_war[wAttack]));
		send_family_chat(family_war[wAttack], String144);

        family_war[wStatus] = 2;
        family_war[wTimer] = 600;
    }
    else if(family_war[wTimer] > 0 && family_war[wStatus] == 2)
    {
        family_war[wTimer]--;
    }

    else if(family_war[wTimer] == 0 && family_war[wStatus] == 2)
    {
    	get_family_war_winner();
    }
	return true;
}

stock get_family_war_winner()
{
	if(family_war[wTimer] == 0 && family_war[wStatus] == 2)
	{
		if(family_war[wDScore] > family_war[wAScore] || family_war[wAScore] == 0 && family_war[wDScore] == 0)
		{
			format(String144, sizeof(String144), "%s[%s %s] Вы выиграли стрелу! И получили %i рублей в общак семьи и %i опыта семьи"
				,  get_color_family(family_war[wDefense]), get_family_tag_type(family_war[wDefense]), get_family_name(family_war[wDefense]), FAMILY_WAR_WIN_MONEY, FAMILY_WAR_WIN_EXP);
			send_family_chat(family_war[wDefense], String144);

			format(String144, sizeof(String144), "%s[%s %s] Вы проиграли стрелу"
				,  get_color_family(family_war[wAttack]), get_family_tag_type(family_war[wAttack]), get_family_name(family_war[wAttack]));
			send_family_chat(family_war[wAttack], String144);

			format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_money =  family_money + %i, family_win = family_win + 1 WHERE family_id  = '%i'",
		    	FAMILY_WAR_WIN_MONEY,
		    	family_war[wDefense]);

			format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_lose = family_lose + 1 WHERE family_id  = '%i'",
		    	family_war[wAttack]);

			give_family_point(family_war[wDefense], FAMILY_WAR_WIN_EXP);
		}
		else if(family_war[wAScore] > family_war[wDScore] || family_war[wAScore] == family_war[wDScore])
		{
			format(String144, sizeof(String144), "%s[%s %s] Вы выиграли стрелу! И получили %i рублей в общак семьи и %i опыта семьи"
				,  get_color_family(family_war[wAttack]), get_family_tag_type(family_war[wAttack]), get_family_name(family_war[wAttack]), FAMILY_WAR_WIN_MONEY, FAMILY_WAR_WIN_EXP);
			send_family_chat(family_war[wAttack], String144);

			format(String144, sizeof(String144), "%s[%s %s] Вы проиграли стрелу"
				,  get_color_family(family_war[wDefense]), get_family_tag_type(family_war[wDefense]), get_family_name(family_war[wDefense]));
			send_family_chat(family_war[wDefense], String144);

			format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_money =  family_money + %i, family_win = family_win + 1 WHERE family_id  = '%i'",
		    	FAMILY_WAR_WIN_MONEY,
		    	family_war[wAttack]);

			format(String256, sizeof(String256), "UPDATE `family` SET \
		    	family_lose = family_lose + 1 WHERE family_id  = '%i'",
		    	family_war[wDefense]);

			give_family_point(family_war[wAttack], FAMILY_WAR_WIN_EXP);
		}

		foreach(new i : Player)
		{
			if(pData[i][pFamily])	
			{
				for(new z; z < 8; z++)
					TextDrawHideForPlayer(i, tdBizWar[z]);
				GangZoneHideForPlayer(i, family_war[wZone]);
			}			
		}

		GangZoneDestroy(family_war[wZone]);
		DestroyDynamicArea(family_war[wArea]);

		mafia_war[wStatus] = 0;
		mafia_war[wDefense] = 0;
		mafia_war[wAttack] = 0;
		mafia_war[wDScore] = 0;
		mafia_war[wAScore] = 0;
		mafia_war[wBizID] = 0;
		mafia_war[wTimer] = 0;
	}
	return true;
}

stock kill_on_family_war(playerid, killerid) // OnplayerDeath
{
	if(killerid != INVALID_PLAYER_ID)
	{
		if(pData[killerid][pFamily] && pData[playerid][pFamily] && family_war[wStatus] == 2)
		{
		    if(IsPlayerInDynamicArea(killerid, family_war[wArea]))
		    {

			    if(pData[killerid][pFamily] != pData[playerid][pFamily] && pData[killerid][pFamily] == family_war[wAttack] && family_war[wStatus] == 2)
			    {
			    	pData[killerid][pFamilyKills] ++;
			    	UpdatePlayerData(killerid, "pFamilyKills", pData[killerid][pFamilyKills]);

			    	pData[playerid][pFamilyDeaths] ++;
			    	UpdatePlayerData(playerid, "pFamilyDeaths", pData[playerid][pFamilyDeaths]);

			     	family_war[wAScore] += 1;

			    	update_player_kd(playerid);
			    	update_player_kd(killerid);
			    }

			    else if(pData[killerid][pFamily] != pData[playerid][pFamily] && pData[killerid][pFamily] == family_war[wDefense] && family_war[wStatus] == 2) 
			    {
			    	pData[killerid][pFamilyKills] ++;
			    	UpdatePlayerData(killerid, "pFamilyKills", pData[killerid][pFamilyKills]);

			    	pData[playerid][pFamilyDeaths] ++;
			    	UpdatePlayerData(playerid, "pFamilyDeaths", pData[playerid][pFamilyDeaths]);

			    	family_war[wDScore] += 1;

			    	update_player_kd(playerid);
			    	update_player_kd(killerid);
			    }
			    update_family_text_draw();
	    	}
		}
	}
	return true;
}

stock update_family_text_draw()
{
	new
        str_mafia[5];

    format(str_mafia, sizeof str_mafia, "%i", family_war[wDScore]);
    TextDrawSetString(tdBizWar[1], str_mafia);

    format(str_mafia, sizeof str_mafia, "%i", family_war[wAScore]);
    TextDrawSetString(tdBizWar[2], str_mafia);

    return true;
}

stock family_war_connect(playerid)// При загрузке перса
{
	if(pData[playerid][pFamily] && family_war[wStatus])
	{
		GangZoneShowForPlayer(playerid, family_war[wZone], 0xFF0000AA);
		for(new z; z < 8; z++)
			TextDrawShowForPlayer(playerid, tdBizWar[z]);
	}
	return true;
}

stock get_family_vehicle_pos(playerid, sql_id)
{
	new 
		fam = pData[playerid][pFamily];

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(family_vehicle_sql[fam][i] == sql_id)
		{

			new Float:x, Float:y, Float:z;

			GetVehiclePos(family_vehicle[fam][i], x, y, z);
			
			SetPlayerCheckpoint(playerid, x, y, z, 4.0);

			pTemp[playerid][pGPS] = true;

			SendSucc(playerid, "Вы отметили транспортное средство на карте");
			break;
		}
	}
	return true;
}

stock show_family_vehicle_menu(playerid, sql_id)
{
	SetPVarIntNew(playerid, "family_veh_sql", sql_id);

	SPD(playerid, DIALOG_FAMILY_VEHICLE, DIALOG_STYLE_LIST, !""cBLUE"Семейный транспорт", "\
		"cBLUE"1. "cWH"Отметить транспорт на GPS\n\
		"cBLUE"2. "cWH"Заспавнить транспорт "cGR"(1000 рублей)\n\
		"cBLUE"3. "cWH"Выгрузить транспорт с сервера "cGR"(1000 рублей)", !"Выбрать", !"Назад");
	return true;
}


callback:: spawn_family_vehicle(sql_id)
{
	format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `id` = '%i'", sql_id);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_veh = sql_num_rows(result);

	if(!all_veh)
		return true;

	new 
		fam = sql_get_field_assoc_int_ex(result, 0, "family_id"),	
		model = sql_get_field_assoc_int_ex(result, 0, "model"),
		c1 = sql_get_field_assoc_int_ex(result, 0, "color_1"),
		c2 = sql_get_field_assoc_int_ex(result, 0, "color_2"),
		Float:x = sql_get_field_assoc_float_ex(result, 0, "parking_x"),
		Float:y = sql_get_field_assoc_float_ex(result, 0, "parking_y"),
		Float:z = sql_get_field_assoc_float_ex(result, 0, "parking_z"),
		Float:a = sql_get_field_assoc_float_ex(result, 0, "parking_a"),
		car_vw = sql_get_field_assoc_int_ex(result, 0, "parking_vw");

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(family_vehicle_sql[fam][i] == 0 && family_vehicle[fam][i] == 0)
		{
			if(x == 2297.37 && y == -1847.44 && z == 21.2646)
			{
				new 
					random_pos = random(30);

				x = position_spawn_autosalon_3[random_pos][0];
				y = position_spawn_autosalon_3[random_pos][1];
				z = position_spawn_autosalon_3[random_pos][2];
				a = position_spawn_autosalon_3[random_pos][3];
			}

			family_vehicle_sql[fam][i] = sql_id;
			family_vehicle[fam][i] = CreateVehicle(model, x, y, z, a, c1, c2, 5000);

			SetVehicleVirtualWorld(family_vehicle[fam][i], car_vw);

			vehicle[family_vehicle[fam][i]][cOwnTo] = sql_id;
			vehicle[family_vehicle[fam][i]][cFamilyOwner] = fam;

			vehicle[family_vehicle[fam][i]][cFuel] = transport_config[model-400][transport_tank];

			break;
		}
	}

	sql_free_result(result);
	return true;
}

callback:: fam_members(fam) 
{
	new 
		rows;

	format(String512, sizeof(String512), "SELECT * FROM accounts WHERE pFamily = '%d'", fam);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	rows = sql_num_rows(result);

	sql_next_row(result);
	return rows;
}

callback:: get_family_vehilces_count(family_ids)
{
	new 
		rows;

	format(String512, sizeof(String512), "SELECT * FROM family_vehicles WHERE family_id = '%i'", family_ids);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	rows = sql_num_rows(result);

	sql_next_row(result);
	return rows;
}

callback:: payday_family() // в конец функции PayDay
{
	new 
		fam_id,
		fam_online,
		fam_online_leader,
		fam_online_zam,
		fam_online_fraction,
		rows,
		off_leader;

	format(String512, sizeof(String512), "SELECT * FROM family");
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	rows = sql_num_rows(result);


	for(new i; i < rows; i++)
	{
		fam_id = sql_get_field_assoc_int_ex(result, i, "family_id");

		fam_online = fam_members_online(fam_id);

		foreach(new p : logged_players)
		{
			if(pData[p][pFamily] == fam_id)
			{
				if(IsALeader(p))
				{
					fam_online_leader += 3;
				}
				if(IsAZam(p))
				{
					fam_online_zam += 2;
				}
				if(pData[p][pRank] >= 3 && !IsALeader(p) && !IsAZam(p))
				{
					fam_online_fraction++;
				}
			}
		}

		format(String512, sizeof(String512), "SELECT * FROM accounts WHERE pFamily = '%i' AND rank > 9 AND status = 0", fam_id);
		new Result:result_players = sql_queryEx(zConn, String512, QUERY_CACHED);

		off_leader = sql_num_rows(result_players);

		sql_free_result(result_players);

		new 
			total_point = fam_online + fam_online_leader + fam_online_zam + fam_online_fraction + off_leader;

		if(get_family_type(fam_id) >= 3)
		{
			give_family_point(fam_id, total_point*2);
		}
		else
		{
			give_family_point(fam_id, total_point);
		}
	}

	sql_next_row(result);
	return true;	
}

stock IsAZam(playerid)
{
	new fractionid = pData[playerid][pFraction];
	new rank = pData[playerid][pRank];

	if(fractionid == 0)
		return false;

	switch(fractionid)
	{
		case 1..15: if(rank == 9) return true;
	}
	return false;
}

callback:: give_family_point(fam_id, point)
{
	if(point == 0)
		return true;

	new 
		fam_level,
		fam_point;

	format(String512, sizeof(String512), "SELECT * FROM family WHERE family_id = '%i'", fam_id);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	fam_level = sql_get_field_assoc_int_ex(result, 0, "family_level");
	fam_point = sql_get_field_assoc_int_ex(result, 0, "family_point");

	format(String144, sizeof(String144), "%s[%s %s] Было получено %i очков опыта"
		,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), point);
	send_family_chat(fam_id, String144);

	fam_point += point;

	if(fam_point >= fam_level*FAMILY_POINT_COEFFCIENT)
	{	
		fam_point = fam_point - fam_level*FAMILY_POINT_COEFFCIENT;
		fam_level ++;

		format(String144, sizeof(String144), "%s[%s %s] Уровень семьи был повышен на %i"
			,  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), fam_level);
		send_family_chat(fam_id, String144);
	}

	format(String256, sizeof(String256), "UPDATE `family` SET \
    	family_level = '%i',\
    	family_point = '%i'\
    	WHERE family_id = '%i'",
    	fam_level,
    	fam_point,
    	fam_id);

	sql_queryEx(zConn, String256, QUERY_THREADED);

	sql_next_row(result);
	return true;
}

stock fam_members_online(fam)
{
	new 
		 count = 0;

	foreach(new i: logged_players)
	{
		if(pData[i][pFamily] == fam)
		{
			count ++;
		}
	}

	return count;
}


stock get_color_family(fam)
{
	new 
		colorf[32];

	new 
		color,
		query[128];


	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:r = sql_queryEx(zConn, query);

	color = sql_get_field_assoc_int_ex(r, 0, "family_color");

	sql_free_result(r);

	switch(color)
	{
		case 1: colorf = "{3366FF}";
		case 2: colorf = "{6633FF}";
		case 3: colorf = "{CC33FF}";
		case 4: colorf = "{FF33CC}";
		case 5: colorf = "{33CCFF}";
		case 6: colorf = "{FF3366}";
		case 7: colorf = "{33FFCC}";
		case 8: colorf = "{B88A00}";
		case 9: colorf = "{F5B800}";
		case 10: colorf = "{FF6633}";
		case 11: colorf = "{33FF66}";
		case 12: colorf = "{66FF33}";
		case 13: colorf = "{CCFF33}";
		case 14: colorf = "{E00000}";
		case 15: colorf = "{660066}";
		case 16: colorf = "{990000}";
		case 17: colorf = "{999900}";
		case 18: colorf = "{FFFF14}";
		case 19: colorf = "{FF9966}";
		case 20: colorf = "{FF6633}";
		case 21: colorf = ""cWH"";
	}
	return colorf;
}

CMD:k(playerid, params[])
{
	if(pData[playerid][pFamily] == -1) 
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");

	if(pData[playerid][pMut])
	{
		return SendErr(playerid, "У Вас бан чата. Используйте /time чтобы узнать время бана.");
	}
	if(pTemp[playerid][pMutM])
	{
		return SendErr(playerid, "У Вас затычка во рту.");
	}

	if(pData[playerid][pMutFamily])
		return SendErr(playerid, "У вас блокировка чата рации семьи! Используйте /time!");

	if(sscanf(params, "s[90]", params[0])) 
		return SendInf(playerid, "/k [Текст]");

	new 
		fam_id = pData[playerid][pFamily],
		fam_rank = pData[playerid][pFamilyRank]-1;

	format(String256, sizeof(String256), "%s[%s %s] %s %s [%d]: "cWH"%s",  get_color_family(fam_id), get_family_tag_type(fam_id), get_family_name(fam_id), get_rang_family(fam_id, fam_rank), pData[playerid][pNickname], playerid, params[0]);
	send_family_chat(fam_id, String256);
	return true;
}

stock get_rang_family(fam_id, fam_rank)
{
	new 
		rank_name[24],
		query[526];

	format(query,sizeof(query),"SELECT \
		`family_rank_1`,\
		`family_rank_2`,\
		`family_rank_3`,\
		`family_rank_4`,\
		`family_rank_5`,\
		`family_rank_6`,\
		`family_rank_7`\
		FROM `family` WHERE `family_id` = '%d'", fam_id);
	new Result:r = sql_queryEx(zConn, query);

	sql_get_field(r, fam_rank, rank_name, 32);

	sql_free_result(r);
	return rank_name;
}

CMD:fpass(playerid, params[])
{
	if(sscanf(params, "d", params[0])) 
	{
		show_family_pass(playerid, playerid);

		SendInf(playerid, "/fpass [ID игрока]");
		return true;
	}

	if(!IsPlayerConnected(params[0]) || IsKicked(params[0])) 
		return SendErr(playerid, "Неверный ID");

	if(GetPlayerDistanceToPlayer(playerid, params[0]) > 3.0 || GetPlayerVirtualWorld(playerid) != GetPlayerVirtualWorld(params[0])) 
		return SendErr(playerid, "Вы далеко друг от друга");

	format(String144, sizeof(String144), "Вы предложили "cBLUE"%s "cWH"показать семейный паспорт", pData[params[0]][pNickname]);
	SendSucc(playerid, String144);

	format(String256, sizeof(String256), "\n\
		"cWH"Игрок "cBLUE"%s "cWH"предлагает Вам показать семейный паспорт\n\n\
		"cWH"Вы действительно хотите посмотреть его?", pData[playerid][pNickname]);

	SPD(params[0], DIALOG_ACCEPT_FAMILY_PASS, DIALOG_STYLE_MSGBOX, !""cBLUE"Паспорт семьи", String256, !"Принять", !"Отменить");


	SetPVarIntNew(playerid, "offer_show_family_pass", params[0]+1);
	SetPVarIntNew(params[0], "recieve_show_family_pass", playerid+1);

	return true;
}

stock show_family_pass(playerid, offerid)
{
	if(playerid == offerid)
	{
		format(String64, sizeof(String64), "%s семейный паспорт и рассматривает его", pData[playerid][pSex] == 1 ? ("достал") : ("достала"));
		MeAction(playerid, String64);
	}
	else
	{
		format(String64, sizeof(String64), "%s семейный паспорт и показал %s", pData[playerid][pSex] == 1 ? ("достал") : ("достала"), pData[offerid][pNickname]);
		MeAction(playerid, String64);
	}

	format(String256, sizeof(String256), "\n\
		"cWH"Имя: "cBLUE"%s\n\
		"cWH"Семья: "cBLUE"%s\n\
		"cWH"Ранг: "cBLUE"%s\n\
		"cWH"Убийств: "cBLUE"%i\n\
		"cWH"Смертей: "cBLUE"%i\n\
		"cWH"Соотношение Убийств/Смертей: "cBLUE"%.2f",
		pData[playerid][pNickname],
		get_family_name(pData[playerid][pFamily]),
		get_player_rang(playerid),
		pData[playerid][pFamilyKills],
		pData[playerid][pFamilyDeaths],
		pData[playerid][pFamilyKD]);

	SPD(offerid, INVALID_DIALOG_ID, DIALOG_STYLE_MSGBOX, !""cBLUE"Семейный паспорт", String256, !"Закрыть", "");
	return true;
}

CMD:fmute(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");

	new 
		inv_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	inv_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_invite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) || pData[playerid][pFamilyRank] > inv_rank)
	{

		if(sscanf(params, "dds[64]", params[0], params[1], params[2])) 
			return SendInf(playerid, "/fmute [ID игрока] [К-во минут] [Причина]");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendInf(playerid, "Неверный ID игрока");

		if(pData[params[0]][pFamily] != fam)
			return SendErr(playerid, "Игрок не из Вашей семьи!");
		new 
			id = params[0];
		new time = params[1];
		if(time < 10 || time > 180) 
			return SendErr(playerid,"Введите время от 10 до 180 минут");
		if(pData[id][pMutFamily] > 0) 
			return SendErr(playerid, "Данному игроку уже выдан бан чата рации!");

		pData[id][pMutFamily] = time;
		UpdatePlayerData(id,"pMutFamily",time);

		format(String256, sizeof(String256), "%s[%s] %s [%d] выдал блокировку рации %s [%d] на %d минут. Причина: %s",  
			get_color_family(fam), get_family_name(fam), pData[playerid][pNickname], playerid, 
			pData[id][pNickname], id, time, params[2]);
		send_family_chat(fam, String256);    


	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}
	return true;

}

CMD:funmute(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");

	new 
		inv_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	inv_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_invite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) || pData[playerid][pFamilyRank] > inv_rank)
	{

		if(sscanf(params, "d", params[0])) 
			return SendInf(playerid, "/funmute [ID игрока]");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendInf(playerid, "Неверный ID игрока");

		if(pData[params[0]][pFamily] != fam)
			return SendErr(playerid, "Игрок не из Вашей семьи!");

		new id = params[0];

		if(pData[id][pMutFamily] == 0) 
			return SendErr(playerid, "У данного игрока нет мута!");

		pData[id][pMutFamily] = 0;
		UpdatePlayerData(id,"pMutFamily",0);

		format(String256, sizeof(String256), "%s[%s] %s [%d] снял блокировку рации с %s [%d]",  
			get_color_family(fam), get_family_name(fam), pData[playerid][pNickname], playerid, 
			pData[id][pNickname], id);
		send_family_chat(fam, String256);    


	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}
	return true;	
}

CMD:finvite(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");

	new 
		inv_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	inv_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_invite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) || pData[playerid][pFamilyRank] > inv_rank)
	{

		if(sscanf(params, "d", params[0])) 
			return SendInf(playerid, "/finvite [ID игрока]");

		if(get_family_capacity(fam) == 0 && fam_members(fam) == 25)
			return SendErr(playerid, "В семье недостаточно места");

		if(get_family_capacity(fam) == 1 && fam_members(fam) == 50)
			return SendErr(playerid, "В семье недостаточно места");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendInf(playerid, "Неверный ID игрока");

		if(pData[params[0]][pFamily] != -1)
			return SendErr(playerid, "Игрок уже состоит в другой семье!");

		offer_player(playerid, params[0], OFFER_FAMILY_INVITE);

	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}

	return true;
}

CMD:funinvite(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");
	new 
		uninv_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	uninv_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_uninvite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) || pData[playerid][pFamilyRank] > uninv_rank)
	{	

		if(sscanf(params, "d", params[0])) 
			return SendInf(playerid, "/funinvite [ID игрока]");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendInf(playerid, "Неверный ID игрока");

		if(pData[params[0]][pFamily] != pData[playerid][pFamily])
			return SendErr(playerid, "Игрок не состоит в вашей семье");

		if(get_player_fam_owner(params[0], fam))
			return SendErr(playerid, "Невозможно исключить создателя семьи");

		if(get_player_fam_zam(params[0], fam))
			return SendErr(playerid, "Невозможно исключить заместителя семьи");

		if(pData[params[0]][pFamilyRank] >= pData[playerid][pFamilyRank])
			return SendErr(playerid, "Вы неможете исключить человека старше вас по рангу");

		return family_uninvite_player(playerid, params[0]);
	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}
}

CMD:fcar(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи");

	if(GetPVarIntNew(playerid, "active_player_gruz_taxi") == 1)
		return SendErr(playerid, "Невозможно использовать во время работы!");

	if(GetPVarIntNew(playerid, "active_player_gruz_taxi_p") == 1)
		return SendErr(playerid, "Невозможно использовать во время работы!");


	show_family_cars(playerid);

	return true;
}

stock show_family_cars(playerid)
{
	new 
		fam_id = pData[playerid][pFamily];

	format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `family_id` = '%i'", fam_id);
	new Result:family_all_vehicles = sql_queryEx(zConn, String512, QUERY_CACHED);

	new all_veh = sql_num_rows(family_all_vehicles);

	if(!all_veh)
		return SendErr(playerid, "Транспорт не найден");

	new 
		string[1024],	
		sql_id,
		modelid;

	format(string, sizeof(string), "\t"cGREY"№. Транспорт\t"cGREY"Состояние\n");

 	for(new i; i < all_veh; i++)
	{
		sql_id = sql_get_field_assoc_int_ex(family_all_vehicles, i, "id");
		modelid = sql_get_field_assoc_int_ex(family_all_vehicles, i, "model"); 

		format(string, sizeof(string), "%s"cBLUE"%i. "cWH"%s\t"cGREY"%s\n", string, i+1, transport_config[modelid-400][transport_name], get_fam_veh_status(sql_id) == 1 ? ("[Загружена]") : ("[Не загружена]"));
	}

	SPD(playerid, DIALOG_FAMILY_VEHICLES_LIST, DIALOG_STYLE_TABLIST_HEADERS, !""cBLUE"Семейный транспорт", string, !"Выбрать", !"Закрыть");

	sql_next_row(family_all_vehicles);	

	return true;
}

stock get_fam_veh_status(id)
{
	format(String512, sizeof(String512), "SELECT * FROM `family_vehicles` WHERE `id` = '%i'", id);
	new Result:result = sql_queryEx(zConn, String512, QUERY_CACHED);

	new 
		fam_id = sql_get_field_assoc_int_ex(result, 0, "family_id");

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(family_vehicle_sql[fam_id][i] == id)
			return true;
	}

	return false;
}

CMD:fpark(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "У вас нет семьи");

	new 
		fam = pData[playerid][pFamily];

	if(!get_player_fam_owner(playerid, fam) && !get_player_fam_zam(playerid, fam))
		return SendErr(playerid, "Команда доступна основателю и его заместителю");

	if(!get_player_in_family_vehicle(playerid))
		return SendErr(playerid, "Вы должны сидеть в семейном транспорте");

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(GetPlayerVehicleID(playerid) == family_vehicle[fam][i])
		{
			new Float:x, Float:y, Float:z, Float:r;
			GetVehiclePos(family_vehicle[fam][i],x,y,z);
			GetVehicleZAngle(family_vehicle[fam][i],r);

			new 
				car_vw = GetVehicleVirtualWorld(family_vehicle[fam][i]);

			format(String512,sizeof(String512),"UPDATE `family_vehicles` SET `parking_x`='%.4f', `parking_y`='%.4f', `parking_z`='%.4f', `parking_a`='%.4f', `parking_vw` = '%i' WHERE `id`='%i'"
				,x,y,z,r, car_vw, family_vehicle_sql[fam][i]);
			sql_queryEx(zConn, String512, QUERY_THREADED);

			SendSucc(playerid, "Вы перепарковали семейное транспортное средство");
			break;
		}
	}

	return true;
}

stock get_player_in_family_vehicle(playerid)
{
	new 
		fam = pData[playerid][pFamily];

	if(!IsPlayerInAnyVehicle(playerid)) 
		return false;

	for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
	{
		if(GetPlayerVehicleID(playerid) == family_vehicle[fam][i])
			return true;
	}
	return false;
}

CMD:fwar(playerid, params[])
{
	if(pData[playerid][pFamily] == -1) 
    	return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию");

    new 
		fam = pData[playerid][pFamily];

	if(get_family_type(fam) < 2)
		return SendErr(playerid, "Ваша семья не может участвовать в семейных войнах");

	if(!get_player_fam_owner(playerid, fam))
		return SendErr(playerid, "Доступно только основателю");

	if(family_war[wStatus])
		return SendErr(playerid, "В данный момент уже идёт война семьи");

	show_family_war_family_list(playerid);

	return true;
}

CMD:funinviteoff(playerid, params[])
{
    if(pData[playerid][pFamily] == -1) 
    	return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию");

    new 
		uninv_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	uninv_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_uninvite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) || pData[playerid][pFamilyRank] > uninv_rank)
	{

		if(sscanf(params, "s[24]", params[0])) 
			return SendInf(playerid, "/funinviteoff [Ник игрока]");

		new 
			mysql_id,
			fam_rank,
			osnov_id,
			zam_id;

		format(query,sizeof(query),"SELECT * FROM `accounts` WHERE `nickname` = '%s'", params[0]);
		new Result:player_result = sql_queryEx(zConn, query);

		mysql_id = sql_get_field_assoc_int_ex(player_result, 0, "id");
		fam_rank = sql_get_field_assoc_int_ex(player_result, 0, "pFamilyRank");
		sql_free_result(player_result);

		format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
		new Result:r = sql_queryEx(zConn, query);

		osnov_id = sql_get_field_assoc_int_ex(r, 0, "family_owner_id");
		zam_id = sql_get_field_assoc_int_ex(r, 0, "family_c_owner_id");
		sql_free_result(r);

		if(mysql_id == osnov_id || mysql_id == zam_id || fam_rank >= pData[playerid][pFamilyRank])
			return SendErr(playerid, "Вы не можете исключить данного человека");

		format(query, sizeof(query), "UPDATE `accounts` SET `pFamily` = '-1',`pFamilyRank` = '-1' WHERE `nickname` = '%s' AND `pFamily`='%i'"
			, params[0], fam);
		new Result:result = sql_queryEx(zConn, query);
		if(!sql_affected_rows(result)) 
			return SendErr(playerid, "Игрок с введенным ником не найден в Вашей семье");

		format(String144, sizeof(String144), "%s[%s %s] %s исключил из семьи %s",  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), 
			pData[playerid][pNickname], params[0]);
		send_family_chat(fam, String144);

		sql_free_result(result);
		return true;
	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}
}

CMD:fgiverank(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");
	
	new 
		fam_give_rank,
		fam = pData[playerid][pFamily],
		query[256];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:fam_result = sql_queryEx(zConn, query);

	fam_give_rank = sql_get_field_assoc_int_ex(fam_result, 0, "family_level_uninvite_rank");
	sql_free_result(fam_result);

	if(get_player_fam_owner(playerid, fam) || get_player_fam_zam(playerid, fam) ||pData[playerid][pFamilyRank] > fam_give_rank)
	{		

		if(sscanf(params, "d", params[0])) 
			return SendInf(playerid, "/fgiverank [ID игрока]");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendErr(playerid, "Неверный ID игрока");

		if(pData[params[0]][pFamily] != pData[playerid][pFamily])
			return SendErr(playerid, "Игрок не состоит в вашей семье");

		return select_giverank_player(playerid, params[0]);
	}
	else
	{
		return SendErr(playerid, "Вам недоступна данная команда");
	}
}

CMD:fzam(playerid, params[])
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");
	
	new 
		fam = pData[playerid][pFamily];

	new 
		zam_id,
		query[526];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:r = sql_queryEx(zConn, query);

	zam_id = sql_get_field_assoc_int_ex(r, 0, "family_c_owner_id");
	sql_free_result(r);

	if(get_player_fam_owner(playerid, fam))
	{		

		if(sscanf(params, "d", params[0])) 
			return SendInf(playerid, "/fzam [ID игрока]");

		if(!IsPlayerConnected(params[0]) || params[0] == playerid) 
			return SendErr(playerid, "Неверный ID игрока");

		if(pData[playerid][pFamily] != pData[params[0]][pFamily])
			return SendErr(playerid, "Игрок не явялется членом Вашей семьи");

		if(get_player_fam_zam(params[0], fam))
			return SendErr(playerid, "Данный член семьи уже является заместителем!");

		if(zam_id != -1)
			return SendErr(playerid, "У вас уже имеется заместитель, сперва вам нужно его понизить или уволить!");

		format(String256, sizeof(String256), "UPDATE `family` SET \
	    	family_c_owner_id = '%d'\
	    	WHERE family_id = '%d'",
	    	pData[params[0]][pMysqlID],
	    	fam);

    	sql_queryEx(zConn, String256, QUERY_THREADED);

		format(String256, sizeof(String256), "%s[%s %s] %s [%d] был назначен заместителем семьи основателем %s [%d]",  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), 
			pData[params[0]][pNickname], params[0], pData[playerid][pNickname], playerid);
		send_family_chat(fam, String256);	
		return true;
	}
	else
	{
		SendErr(playerid, "Доступно только создателю семьи");
	}
	return true;
}

CMD:funzam(playerid)
{
	if(pData[playerid][pFamily] == -1)
		return SendErr(playerid, "Вы не состоите в семье, чтобы использовать данную функцию!");
	
	new 
		fam = pData[playerid][pFamily];

	if(!get_player_fam_owner(playerid, fam))
		return SendErr(playerid, "Доступно только основателю");

	new 
		zam_id,
		name[24],
		query[526];

	if(fam == -1)
		return true;

	format(query,sizeof(query),"SELECT * FROM `family` WHERE `family_id` = '%d'", fam);
	new Result:r = sql_queryEx(zConn, query);

	zam_id = sql_get_field_assoc_int_ex(r, 0, "family_c_owner_id");
	sql_free_result(r);
 
	if(zam_id == -1)
		return SendErr(playerid, "У вас нет заместителя!");

	GetPlayerNameByID(zam_id, name);

	format(String256, sizeof(String256), "%s[%s %s] %s был снят с поста заместителя семьи основателем %s [%d]",  get_color_family(fam), get_family_tag_type(fam), get_family_name(fam), 
		name, pData[playerid][pNickname], playerid);
	send_family_chat(fam, String256);	

	format(String256, sizeof(String256), "UPDATE `family` SET \
    	family_c_owner_id = '-1'\
    	WHERE family_id = '%d'",
    	fam);

	sql_queryEx(zConn, String256, QUERY_THREADED);
	return true;
}

stock send_family_chat(family_ids, msg[])
{

	foreach(new i: logged_players)
	{
		if(pData[i][pFamily] == family_ids)
		{
			SendClientMessage(i, -1, msg);
		}
	}
	return true;
}

stock clear_family_label_text(playerid)
{
	if(fam_lable[playerid] != Text3D:-1) 
	{
		DestroyDynamic3DTextLabel(fam_lable[playerid]);
		fam_lable[playerid] = Text3D:-1;
	}

	return true;
}

stock create_family_label_text(i)
{
	new 
		fam_id = pData[i][pFamily],
		string[144];

	if(pData[i][pFamily] != -1) 
	{
		if(fam_lable[i] == Text3D:-1) 
		{
			format(string, sizeof(string), "%s %s%s", get_family_tag_type(fam_id), get_color_family(fam_id), get_family_name(fam_id));
			fam_lable[i] = CreateDynamic3DTextLabel(string, -1, 0.0, 0.0, 0.025, 5.0, i, INVALID_VEHICLE_ID, 1);
		}
	}
	else if((fam_lable[i] != Text3D:-1 && pData[i][pFamily] == -1) || (fam_lable[i] != Text3D:-1)) 
	{
		DestroyDynamic3DTextLabel(fam_lable[i]);
		fam_lable[i] = Text3D:-1;
	}
	return true;
}


stock update_family_label_text(i)
{
	new 
		fam_id = pData[i][pFamily]; 

	new famtext[50];
	format(famtext,sizeof(famtext),"%s %s%s", get_family_tag_type(fam_id), get_color_family(fam_id), get_family_name(fam_id));
	UpdateDynamic3DTextLabelText(fam_lable[i], -1, famtext);

	return true;
}

alias:flock("flk");
CMD:flock(playerid)
{
	new 
		fam = pData[playerid][pFamily]; 

	foreach(new v:vehicle_in_stream[playerid])
	{	
		new
			Float:pl_pos_x,
			Float:pl_pos_y,
			Float:pl_pos_z;

		GetVehiclePos(v, pl_pos_x, pl_pos_y, pl_pos_z);

		for(new i; i < MAX_FAMILY_VEHICLES_2; i++)
		{

			if(v == family_vehicle[fam][i])
			{
				new engine, lights, doors, bonnet, boot, objective;

				if(IsPlayerInRangeOfPoint(playerid, 7.0, pl_pos_x, pl_pos_y, pl_pos_z))
				{
					if(vehicle[v][cLock])
					{
						GameTextForPlayer(playerid, "~g~OPEN", 200, 1);

						vehicle_lock_status(v, false);

						vehicle_light_status(v, 1);

						SetTimerEx("lock_vehicle_light_p", 1000, false, "ii", playerid, v);
						new mese[120];
						format(mese,sizeof(mese),"открыл(а) семейное транспортное средство «%s»", transport_config[GetVehicleModel(v)-400][transport_name]);
						MeAction(playerid ,mese);

						SendSucc(playerid, "Вы открыли семейный транспорт!");

					}
					else
					{
						GameTextForPlayer(playerid, "~r~LOCK", 200, 1);

						vehicle_lock_status(v, true);
						vehicle_light_status(v, 1);

						SetTimerEx("lock_vehicle_light_p", 1000, false, "ii", playerid, v);

						new mese[120];
						format(mese,sizeof(mese),"закрыл(а) семейное транспортное средство «%s»", transport_config[GetVehicleModel(v)-400][transport_name]);
						MeAction(playerid ,mese);

						SendSucc(playerid, "Вы закрыли семейный транспорт!");
					}
				}
				else
				{
					SendInf(playerid, "Вы слишком далеко от транспорта!");
				}
				break;
			}
		}

	}

	return true;
}

CMD:afuninvite(playerid, params[])
{
	if(pData[playerid][pAdmin] < 7) 
		return NoCMD(playerid);

	if(sscanf(params, "d", params[0])) 
		return SendInf(playerid, "/afuninvite [ID игрока]");

	if(pData[params[0]][pFamily] == -1)
		return SendErr(playerid, "Игрок не состоит в семье!");

	pData[params[0]][pFamily] = -1;
	pData[params[0]][pFamilyRank] = -1;

    UpdatePlayerData(params[0], "pFamily", pData[params[0]][pFamily]);
    UpdatePlayerData(params[0], "pFamilyRank", pData[params[0]][pFamilyRank]);

    clear_family_label_text(params[0]);

    SendSucc(playerid, "Вы успешно выкинули игрока из семьи!");
    SendSucc(params[0], "Администратор выкинул Вас из семьи!");

	return true;
}

CMD:achangefamilyp(playerid, params[])
{
	if(pData[playerid][pAdmin] < 7) 
		return NoCMD(playerid);

	if(sscanf(params, "dd", params[0], params[1])) 
		return SendInf(playerid, "/achangefamilyp [ID игрока] [ID Семьи]");

	pData[params[0]][pFamily] = params[1];
	pData[params[0]][pFamilyRank] = 1;

    UpdatePlayerData(params[0], "pFamily", pData[params[0]][pFamily]);
    UpdatePlayerData(params[0], "pFamilyRank", pData[params[0]][pFamilyRank]);

    clear_family_label_text(params[0]);

    SendSucc(playerid, "Вы успешно выкинули игрока из семьи!");
    SendSucc(params[0], "Администратор выкинул Вас из семьи!");

    create_family_label_text(params[0]);
    update_family_label_text(params[0]);

	return true;
}